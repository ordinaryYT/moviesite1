<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ogmovie</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#000;color:#fff;font-family:Arial,sans-serif}
  header{text-align:center;padding:2rem;position:relative}
  h1{color:#e50914;font-size:2.5rem}
  #adminBtn{position:absolute;top:2rem;right:2rem;background:#e50914;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;font-weight:bold}
  #searchContainer{max-width:500px;margin:0 auto 2rem auto;padding:0 2rem}
  #searchInput{width:100%;padding:1rem;border-radius:8px;border:2px solid #333;background:#1a1a1a;color:#fff;font-size:1.1rem}
  #searchInput:focus{outline:none;border-color:#e50914}
  #movieGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1.5rem;padding:2rem;max-width:1400px;margin:0 auto}
  .movie-card{cursor:pointer;border-radius:12px;overflow:hidden;background:#1a1a1a;transition:.3s}
  .movie-card:hover{transform:scale(1.05);box-shadow:0 0 20px rgba(229,9,20,.5)}
  .movie-card img{width:100%;height:300px;object-fit:cover}
  .movie-info{padding:1rem;text-align:center}
  .movie-info h3{font-size:1.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .movie-info p{color:#aaa;font-size:.9rem}
  
  /* Modal Styles */
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#1a1a1a;padding:2rem;border-radius:12px;width:90%;max-width:400px;position:relative}
  .close-modal{position:absolute;top:10px;right:15px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer}
  .modal h2{margin-bottom:1.5rem;color:#e50914}
  .form-group{margin-bottom:1rem}
  .form-group label{display:block;margin-bottom:0.5rem;color:#ccc}
  .form-group input{width:100%;padding:0.75rem;border-radius:4px;border:1px solid #333;background:#333;color:#fff}
  .modal-btn{width:100%;padding:0.75rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;margin-top:1rem}
  
  /* Admin Panel Styles */
  #adminPanel{display:none;padding:2rem;max-width:1400px;margin:0 auto}
  #adminPanel.active{display:block}
  .admin-actions{margin-bottom:2rem;display:flex;gap:1rem}
  .admin-btn{padding:0.75rem 1.5rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold}
  .admin-btn.disabled{background:#555;cursor:not-allowed}
  .movie-list-admin,.global-password-list{margin-top:2rem}
  .movie-item-admin,.global-password-item{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#1a1a1a;margin-bottom:1rem;border-radius:8px}
  .movie-item-admin button,.global-password-item button{background:#ff4444;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer}
  #adminSearchContainer{max-width:500px;margin-bottom:2rem}
  #adminSearchInput{width:100%;padding:1rem;border-radius:8px;border:2px solid #333;background:#1a1a1a;color:#fff;font-size:1.1rem}
  #adminSearchInput:focus{outline:none;border-color:#e50914}
  
  /* Player Styles */
  .player-container{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:9999}
  .player-container.active{display:block}
  .close-btn{position:absolute;top:20px;right:20px;background:rgba(0,0,0,.7);color:white;border:none;width:50px;height:50px;border-radius:50%;font-size:2rem;cursor:pointer;z-index:10000}
  .player-wrapper{position:relative;width:100%;height:100%}
  #playerIframe{width:100%;height:100%;border:none}
  .iframe-overlay{position:absolute;top:5px;left:0;width:160px;height:55px;background:#000;z-index:3;display:flex;align-items:center;justify-content:center;font-weight:bold;color:rgba(255,255,255,.5);letter-spacing:2px;text-transform:uppercase;border-radius:8px;}
  .bottom-left-overlay {
    position:absolute;bottom:10px;left:200px;width:120px;height:40px;background:#000;z-index:10;border-radius:8px;
  }
</style>
</head>
<body>

<header>
  <h1>ogmovie</h1>
  <button id="adminBtn">Admin</button>
</header>
<main>
  <div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Search for movies or TV shows..." />
  </div>
  <div id="movieGrid"></div>
  <div id="adminPanel" class="admin-panel"></div>
</main>
<!-- Admin Login Modal -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeLoginModal()">×</button>
    <h2>Admin Login</h2>
    <div class="form-group">
      <label for="adminPassword">Password:</label>
      <input type="password" id="adminPassword" placeholder="Enter admin password">
    </div>
    <button class="modal-btn" onclick="adminLogin()">Login</button>
  </div>
</div>

<!-- Add Content Modal -->
<div id="addContentModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeAddContentModal()">×</button>
    <h2>Add Content</h2>
    <div class="form-group">
      <label for="contentTitle">Title:</label>
      <input type="text" id="contentTitle" placeholder="Enter movie or TV show title">
    </div>
    <div class="form-group">
      <label for="contentImdbId">IMDb ID (optional):</label>
      <input type="text" id="contentImdbId" placeholder="tt1234567">
    </div>
    <div class="form-group">
      <label for="contentType">Type:</label>
      <select id="contentType">
        <option value="movie">Movie</option>
        <option value="tv_show">TV Show</option>
      </select>
    </div>
    <div class="form-group">
      <label for="contentPasswords">Passwords (comma-separated):</label>
      <input type="text" id="contentPasswords" placeholder="password1,password2,...">
    </div>
    <div class="form-group">
      <label for="oneTimePasswords">One-Time Passwords (comma-separated, optional):</label>
      <input type="text" id="oneTimePasswords" placeholder="otp1,otp2,...">
    </div>
    <button class="modal-btn" onclick="addContent()">Add Content</button>
  </div>
</div>

<!-- Add Global Password Modal -->
<div id="globalPasswordModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeGlobalPasswordModal()">×</button>
    <h2>Add Global Password</h2>
    <div class="form-group">
      <label for="globalPassword">Password:</label>
      <input type="text" id="globalPassword" placeholder="Enter global password">
    </div>
    <div class="form-group">
      <label for="isOneTimePassword">
        <input type="checkbox" id="isOneTimePassword"> One-Time Password
      </label>
    </div>
    <button class="modal-btn" onclick="addGlobalPassword()">Add Password</button>
  </div>
</div>

<!-- Password Modal -->
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closePasswordModal()">×</button>
    <h2>Enter Password</h2>
    <p id="passwordContentTitle" style="margin-bottom:1rem;color:#ccc"></p>
    <div class="form-group">
      <label for="contentPasswordInput">Password:</label>
      <input type="password" id="contentPasswordInput" placeholder="Enter password">
    </div>
    <button class="modal-btn" onclick="verifyContentPassword()">Watch</button>
  </div>
</div>

<!-- Player Container -->
<div id="playerContainer" class="player-container">
  <button class="close-btn" onclick="closePlayer()">X</button>
  <div class="player-wrapper">
    <iframe id="playerIframe" allowfullscreen allow="autoplay; fullscreen" referrerpolicy="no-referrer"></iframe>
    <div class="iframe-overlay">ogmovie</div>
    <div class="bottom-left-overlay"></div>
  </div>
</div>

<script>
const API = window.location.origin + '/api';
const EMBED_BASE_MOVIE = 'https://vidsrc.me/embed/movie/';
const EMBED_BASE_TV = 'https://vidsrc.me/embed/tv/';
const movieGrid = document.getElementById('movieGrid');
const playerIframe = document.getElementById('playerIframe');
const playerContainer = document.getElementById('playerContainer');
const adminBtn = document.getElementById('adminBtn');
const adminPanel = document.getElementById('adminPanel');
const loginModal = document.getElementById('loginModal');
const addContentModal = document.getElementById('addContentModal');
const globalPasswordModal = document.getElementById('globalPasswordModal');
const passwordModal = document.getElementById('passwordModal');
const searchInput = document.getElementById('searchInput');

let adminToken = null;
let currentContent = [];
let allContent = [];
let selectedContentId = null;
let passwordsDisabled = false;

// === Search ===
function filterContent(searchTerm) {
  const filteredContent = currentContent.filter(item =>
    item.title.toLowerCase().includes(searchTerm.toLowerCase())
  );
  displayContent(filteredContent);
}

function filterAdminContent(searchTerm) {
  const filteredContent = allContent.filter(item =>
    item.title.toLowerCase().includes(searchTerm.toLowerCase())
  );
  displayAdminContent(filteredContent);
}

function displayContent(items) {
  movieGrid.innerHTML = '';
  if (items.length === 0) {
    movieGrid.innerHTML =
      '<p style="text-align:center;color:#aaa;grid-column:1/-1;">No movies or TV shows found</p>';
    return;
  }
  items.forEach(createContentCard);
}

async function getContentPoster(title, year = '') {
  try {
    const response = await fetch(
      `https://api.tvmaze.com/search/shows?q=${encodeURIComponent(title)}`
    );
    const data = await response.json();
    if (data.length > 0 && data[0].show.image && data[0].show.image.medium) {
      return data[0].show.image.medium;
    }
  } catch {}
  try {
    const wikiResponse = await fetch(
      `https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(
        title.replace(/ /g, '_')
      )}`
    );
    const wikiData = await wikiResponse.json();
    if (wikiData.thumbnail && wikiData.thumbnail.source) {
      return wikiData.thumbnail.source;
    }
  } catch {}
  return `https://via.placeholder.com/300x450/333/fff?text=${encodeURIComponent(
    title.substring(0, 20)
  )}`;
}

async function createContentCard(item) {
  try {
    let img = item.image;
    const year = item.year || 'N/A';
    const poster = await getContentPoster(item.title, year);
    if (!poster.includes('placeholder.com')) img = poster;
    const card = document.createElement('div');
    card.className = 'movie-card';
    card.innerHTML = `
      <img src="${img}" onerror="this.src='https://via.placeholder.com/300x450/333/fff?text=No+Poster'">
      <div class="movie-info"><h3>${item.title}</h3><p>${year} (${item.type === 'movie' ? 'Movie' : 'TV Show'})</p></div>`;
    card.onclick = () => requestContentPassword(item.id, item.title);
    movieGrid.appendChild(card);
  } catch (e) {
    console.error('Content card render failed', e);
  }
}

// === Admin ===
function openAdminPanel() { loginModal.classList.add('active'); }
function closeLoginModal() { 
  loginModal.classList.remove('active');
  document.getElementById('adminPassword').value = '';
}
function closeAddContentModal() { 
  addContentModal.classList.remove('active');
  document.getElementById('contentTitle').value = '';
  document.getElementById('contentImdbId').value = '';
  document.getElementById('contentType').value = 'movie';
  document.getElementById('contentPasswords').value = '';
  document.getElementById('oneTimePasswords').value = '';
}
function closeGlobalPasswordModal() { 
  globalPasswordModal.classList.remove('active');
  document.getElementById('globalPassword').value = '';
  document.getElementById('isOneTimePassword').checked = false;
}

async function adminLogin() {
  const password = document.getElementById('adminPassword').value;
  if (!password) return alert('Please enter password');
  try {
    const res = await fetch(API + '/admin/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    });
    const data = await res.json();
    if (data.ok) {
      adminToken = data.token;
      closeLoginModal();
      showAdminPanel();
      loadAdminContent();
      loadGlobalPasswords();
      checkPasswordDisableStatus();
    } else alert('Invalid password');
  } catch {
    alert('Login failed');
  }
}

async function checkPasswordDisableStatus() {
  try {
    const res = await fetch(API + '/admin/password-status', {
      headers: { Authorization: `Bearer ${adminToken}` }
    });
    const data = await res.json();
    if (data.ok) {
      passwordsDisabled = data.disabled;
      updatePasswordToggleButton();
    }
  } catch {
    console.error('Failed to check password status');
  }
}

function updatePasswordToggleButton() {
  const toggleBtn = document.getElementById('togglePasswordBtn');
  if (toggleBtn) {
    toggleBtn.textContent = passwordsDisabled ? 'Enable Passwords' : 'Disable Passwords';
    toggleBtn.className = `admin-btn ${passwordsDisabled ? '' : 'disabled'}`;
  }
}

async function togglePasswords() {
  try {
    const res = await fetch(API + '/admin/toggle-passwords', {
      method: 'POST',
      headers: { Authorization: `Bearer ${adminToken}` }
    });
    const data = await res.json();
    if (data.ok) {
      passwordsDisabled = data.disabled;
      updatePasswordToggleButton();
      alert(`Passwords ${passwordsDisabled ? 'disabled' : 'enabled'}`);
    } else alert('Error: ' + data.error);
  } catch {
    alert('Failed to toggle passwords');
  }
}

function showAdminPanel() {
  movieGrid.style.display = 'none';
  adminPanel.classList.add('active');
  adminPanel.innerHTML = `
    <h2>Admin Panel</h2>
    <div class="admin-actions">
      <button class="admin-btn" onclick="openAddContentModal()">Add Content</button>
      <button class="admin-btn" onclick="openGlobalPasswordModal()">Add Global Password</button>
      <button class="admin-btn" id="togglePasswordBtn" onclick="togglePasswords()">Loading...</button>
      <button class="admin-btn" onclick="exitAdmin()">Exit Admin</button>
    </div>
    <div id="adminSearchContainer">
      <input type="text" id="adminSearchInput" placeholder="Search movies or TV shows to delete..." />
    </div>
    <div class="movie-list-admin" id="contentListAdmin">
      <h3>Content</h3>
    </div>
    <div class="global-password-list" id="globalPasswordList">
      <h3>Global Passwords</h3>
    </div>`;
  document.getElementById('adminSearchInput').addEventListener('input', e => filterAdminContent(e.target.value));
  checkPasswordDisableStatus(); // Update button state after rendering
}

function exitAdmin() {
  adminToken = null;
  passwordsDisabled = false;
  adminPanel.classList.remove('active');
  movieGrid.style.display = 'grid';
}

function openAddContentModal() { addContentModal.classList.add('active'); }
function openGlobalPasswordModal() { globalPasswordModal.classList.add('active'); }

async function addContent() {
  const title = document.getElementById('contentTitle').value;
  const imdbId = document.getElementById('contentImdbId').value;
  const contentType = document.getElementById('contentType').value;
  const contentPasswords = document.getElementById('contentPasswords').value.split(',').map(p => p.trim()).filter(p => p);
  const oneTimePasswords = document.getElementById('oneTimePasswords').value.split(',').map(p => p.trim()).filter(p => p);
  if (!title && !imdbId) {
    return alert('Please provide title or IMDb ID');
  }
  try {
    const res = await fetch(API + '/content', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${adminToken}`
      },
      body: JSON.stringify({
        name: title,
        imdbId,
        type: contentType,
        contentPasswords,
        oneTimePasswords
      })
    });
    const data = await res.json();
    if (data.ok) {
      alert('Content added successfully');
      closeAddContentModal();
      loadAdminContent();
      loadContent();
    } else alert('Error: ' + data.error);
  } catch {
    alert('Failed to add content');
  }
}

async function addGlobalPassword() {
  const password = document.getElementById('globalPassword').value;
  const isOneTime = document.getElementById('isOneTimePassword').checked;
  if (!password) {
    return alert('Please provide a password');
  }
  try {
    const res = await fetch(API + '/admin/global-passwords', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${adminToken}`
      },
      body: JSON.stringify({ password, isOneTime })
    });
    const data = await res.json();
    if (data.ok) {
      alert('Global password added successfully');
      closeGlobalPasswordModal();
      loadGlobalPasswords();
    } else alert('Error: ' + data.error);
  } catch {
    alert('Failed to add global password');
  }
}

async function loadAdminContent() {
  try {
    const res = await fetch(API + '/content');
    const data = await res.json();
    if (data.ok) {
      allContent = data.items;
      currentContent = data.items;
      displayAdminContent(allContent);
    }
  } catch {
    console.error('Failed to load content');
  }
}

function displayAdminContent(items) {
  const contentListAdmin = document.getElementById('contentListAdmin');
  contentListAdmin.innerHTML = '<h3>Content</h3>';
  if (items.length === 0) {
    contentListAdmin.innerHTML += '<p>No movies or TV shows found</p>';
    return;
  }
  items.forEach(item => {
    const div = document.createElement('div');
    div.className = 'movie-item-admin';
    div.innerHTML = `
      <div><strong>${item.title}</strong> ${item.year ? `(${item.year})` : ''} (${item.type === 'movie' ? 'Movie' : 'TV Show'})</div>
      <button onclick="deleteContent(${item.id})">Delete</button>`;
    contentListAdmin.appendChild(div);
  });
}

async function loadGlobalPasswords() {
  try {
    const res = await fetch(API + '/admin/global-passwords', {
      headers: { Authorization: `Bearer ${adminToken}` }
    });
    const data = await res.json();
    if (data.ok) {
      const globalPasswordList = document.getElementById('globalPasswordList');
      globalPasswordList.innerHTML = '<h3>Global Passwords</h3>';
      if (data.passwords.length === 0) {
        globalPasswordList.innerHTML += '<p>No global passwords set</p>';
        return;
      }
      data.passwords.forEach(password => {
        const item = document.createElement('div');
        item.className = 'global-password-item';
        item.innerHTML = `
          <div>Password #${password.id} (${password.is_one_time ? 'One-Time' : 'Regular'})</div>
          <button onclick="deleteGlobalPassword(${password.id})">Delete</button>`;
        globalPasswordList.appendChild(item);
      });
    }
  } catch {
    console.error('Failed to load global passwords');
  }
}

async function deleteContent(id) {
  if (!confirm('Are you sure you want to delete this content?')) return;
  try {
    const res = await fetch(API + '/content/' + id, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${adminToken}` }
    });
    const data = await res.json();
    if (data.ok) {
      loadAdminContent();
      loadContent();
    } else alert('Error: ' + data.error);
  } catch {
    alert('Delete failed');
  }
}

async function deleteGlobalPassword(id) {
  if (!confirm('Are you sure you want to delete this global password?')) return;
  try {
    const res = await fetch(API + '/admin/global-passwords/' + id, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${adminToken}` }
    });
    const data = await res.json();
    if (data.ok) {
      loadGlobalPasswords();
    } else alert('Error: ' + data.error);
  } catch {
    alert('Delete failed');
  }
}

// === Playback ===
function requestContentPassword(contentId, title) {
  selectedContentId = contentId;
  document.getElementById('passwordContentTitle').textContent = title;
  passwordModal.classList.add('active');
}

function closePasswordModal() {
  passwordModal.classList.remove('active');
  selectedContentId = null;
  document.getElementById('contentPasswordInput').value = '';
}

async function verifyContentPassword() {
  const password = document.getElementById('contentPasswordInput').value;
  if (!password) return alert('Please enter password');
  try {
    const res = await fetch(API + '/content/' + selectedContentId + '/authorize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    });
    const data = await res.json();
    if (data.ok) {
      const embedRes = await fetch(API + '/content/' + selectedContentId + '/embed', {
        headers: { Authorization: `Bearer ${data.token}` }
      });
      const embedData = await embedRes.json();
      if (embedData.ok) showPlayer(embedData.url);
      else alert('Error: ' + embedData.error);
    } else alert('Error: ' + data.error);
  } catch {
    alert('Verification failed');
  }
}

function showPlayer(url) {
  playerIframe.src = url;
  playerContainer.classList.add('active');
  passwordModal.classList.remove('active');
  document.getElementById('contentPasswordInput').value = '';
}

function closePlayer() {
  playerContainer.classList.remove('active');
  playerIframe.src = '';
}

// === Load Content ===
async function loadContent() {
  movieGrid.innerHTML =
    '<p style="text-align:center;color:#aaa;">Loading...</p>';
  try {
    const res = await fetch(API + '/content');
    const data = await res.json();
    if (!data.ok || !data.items.length) {
      movieGrid.innerHTML =
        '<p style="text-align:center;color:#aaa;">No movies or TV shows found.</p>';
      return;
    }
    currentContent = data.items;
    displayContent(currentContent);
  } catch {
    movieGrid.innerHTML =
      '<p style="color:red;text-align:center;">Error loading content.</p>';
  }
}

// === Events ===
adminBtn.addEventListener('click', openAdminPanel);
searchInput.addEventListener('input', e => filterContent(e.target.value));
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closePlayer();
    closeLoginModal();
    closeAddContentModal();
    closeGlobalPasswordModal();
    closePasswordModal();
  }
});

loadContent();
</script>

</body>
</html>
