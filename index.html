<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ogmovie</title>
<script src="/socket.io/socket.io.js"></script>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#000;color:#fff;font-family:Arial,sans-serif}
  header{text-align:center;padding:2rem;position:relative}
  h1{color:#e50914;font-size:2.5rem}
  #adminBtn{position:absolute;top:2rem;right:2rem;background:#e50914;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;font-weight:bold}
  #searchContainer{max-width:500px;margin:0 auto 1rem auto;padding:0 2rem}
  #searchInput{width:100%;padding:1rem;border-radius:8px;border:2px solid #333;background:#1a1a1a;color:#fff;font-size:1.1rem}
  #searchInput:focus{outline:none;border-color:#e50914}
  #filterTabs{text-align:center;margin:1rem 0;}
  #filterTabs button{margin:0 .25rem;padding:.5rem 1rem;background:#1a1a1a;border:none;color:#fff;border-radius:4px;cursor:pointer}
  #filterTabs button.active{background:#e50914}
  #movieGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1.5rem;padding:2rem;max-width:1400px;margin:0 auto}
  .movie-card{cursor:pointer;border-radius:12px;overflow:hidden;background:#1a1a1a;transition:.3s;position:relative}
  .movie-card:hover{transform:scale(1.05);box-shadow:0 0 20px rgba(229,9,20,.5)}
  .movie-card img{width:100%;height:300px;object-fit:cover}
  .movie-info{padding:1rem;text-align:center;position:relative}
  .movie-info h3{font-size:1.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .movie-info p{color:#aaa;font-size:.9rem}
  .card-actions{position:absolute;bottom:8px;right:8px;display:flex;gap:4px;opacity:0;transition:opacity .2s}
  .movie-card:hover .card-actions{opacity:1}
  .card-actions button{background:rgba(0,0,0,.6);border:none;color:#fff;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:.9rem}
  .card-actions button:hover{background:#e50914}
  .favorite-btn.filled{color:#e50914}
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#1a1a1a;padding:2rem;border-radius:12px;width:90%;max-width:400px;position:relative}
  .close-modal{position:absolute;top:10px;right:15px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer}
  .modal h2{margin-bottom:1.5rem;color:#e50914}
  .form-group{margin-bottom:1rem}
  .form-group label{display:block;margin-bottom:0.5rem;color:#ccc}
  .form-group input,.form-group select{width:100%;padding:0.75rem;border-radius:4px;border:1px solid #333;background:#333;color:#fff}
  .modal-btn{width:100%;padding:0.75rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;margin-top:1rem}
  #adminPanel{display:none;padding:2rem;max-width:1400px;margin:0 auto}
  #adminPanel.active{display:block}
  .admin-actions{margin-bottom:2rem;display:flex;gap:1rem;flex-wrap:wrap}
  .admin-btn{padding:0.75rem 1.5rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold}
  .movie-list-admin{margin-top:2rem}
  .movie-item-admin{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#1a1a1a;margin-bottom:1rem;border-radius:8px}
  .movie-item-admin button{background:#ff4444;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer}
  .movie-item-admin button + button{margin-left:0.5rem}
  .player-container{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:999}
  .player-container.active{display:block}
  .close-btn{position:absolute;top:10px;right:10px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;z-index:1001}
  .player-wrapper{position:relative;width:100%;height:100%}
  #playerIframe{width:100%;height:100%;border:none}
  .iframe-overlay{position:absolute;top:5px;left:0;width:160px;height:55px;background:#000;z-index:3;display:flex;align-items:center;justify-content:center;font-weight:bold;color:rgba(255,255,255,.5);letter-spacing:2px;text-transform:uppercase;border-radius:8px;}
  .bottom-left-overlay{position:absolute;bottom:10px;left:200px;width:120px;height:40px;background:#000;z-index:10;border-radius:8px;}
  #requestSection{display:none;padding:2rem;max-width:1400px;margin:0 auto}
  #requestInput{width:100%;max-width:500px;padding:1rem;border-radius:8px;border:2px solid #333;background:#1a1a1a;color:#fff;font-size:1.1rem;margin-bottom:1rem}
  #watchTogetherSection{display:none;padding:2rem;max-width:1000px;margin:2rem auto;background:#111;border-radius:12px;text-align:center}
  .room-item{background:#222;padding:1rem;margin:1rem 0;border-radius:8px;display:flex;justify-content:space-between;align-items:center}
  #playerContainer{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:999}
  #playerContainer.active{display:block}
  #shareVideo{width:100%;height:100%;object-fit:contain;background:#000}
  .close-btn{position:absolute;top:20px;right:20px;font-size:40px;background:none;border:none;color:#fff;cursor:pointer;z-index:1001}
</style>
</head>
<body>
<header>
  <h1>ogmovie</h1>
  <button id="adminBtn">Admin</button>
</header>

<div id="searchContainer">
  <input type="text" id="searchInput" placeholder="Search movies & shows...">
</div>

<div id="filterTabs">
  <button class="active" data-type="all">All</button>
  <button data-type="movie">Movies</button>
  <button data-type="tv">TV Shows</button>
  <button data-type="watch-together">Watch Together</button>
</div>

<div id="movieGrid"></div>

<div id="watchTogetherSection">
  <h2 style="color:#e50914;margin-bottom:1rem">Watch Together (Desktop App Only)</h2>
  <button class="modal-btn" style="padding:1rem 2rem;font-size:1.2rem" onclick="openCreate()">Create Room</button>
  <button class="modal-btn" style="padding:1rem 2rem;font-size:1.2rem;margin-left:1rem" onclick="openJoin()">Join Private</button>
  <h3 style="margin:2rem 0 1rem">Public Rooms</h3>
  <div id="publicRoomsList"></div>
</div>

<div id="playerContainer">
  <button class="close-btn" onclick="closePlayer()">X</button>
  <video id="shareVideo" autoplay playsinline controls></video>
</div>

<!-- Modals -->
<div id="loginModal" class="modal"><div class="modal-content">...</div></div>
<div id="passwordModal" class="modal"><div class="modal-content">...</div></div>
<div id="episodeModal" class="modal"><div class="modal-content">...</div></div>

<!-- Watch Together Modals -->
<div id="createModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="this.parentElement.parentElement.classList.remove('active')">X</button>
    <h2>Create Room</h2>
    <input type="text" id="roomName" placeholder="Room name (optional)">
    <select id="roomType"><option value="public">Public</option><option value="private">Private</option></select>
    <div id="codeDiv" style="display:none;margin:1rem 0">
      <input type="text" id="privateCode" placeholder="Private code">
      <button type="button" onclick="document.getElementById('privateCode').value='ROOM-'+Math.random().toString(36).substr(2,8).toUpperCase()">Generate</button>
    </div>
    <button class="modal-btn" onclick="createRoom()">Create</button>
  </div>
</div>

<div id="joinModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="this.parentElement.parentElement.classList.remove('active')">X</button>
    <h2>Join Private Room</h2>
    <input type="text" id="joinCode" placeholder="Enter code">
    <button class="modal-btn" onclick="joinRoom(document.getElementById('joinCode').value)">Join</button>
  </div>
</div>

<script>
const API = '';
const socket = io();
const isElectron = /electron/i.test(navigator.userAgent);

if (!isElectron) {
  document.querySelector('[data-type="watch-together"]').style.display = 'none';
  document.getElementById('watchTogetherSection').style.display = 'none';
}

// ==================== WATCH TOGETHER FULLY WORKING ====================
let myRoom = null, isHost = false, stream = null, peerConnections = {};
const config = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };

function openCreate() {
  document.getElementById('createModal').classList.add('active');
  document.getElementById('roomType').onchange = () => document.getElementById('codeDiv').style.display = document.getElementById('roomType').value === 'private' ? 'block' : 'none';
}
function createRoom() {
  const name = document.getElementById('roomName').value || 'Movie Night';
  const isPublic = document.getElementById('roomType').value === 'public';
  const code = isPublic ? null : document.getElementById('privateCode').value.trim();
  if (!isPublic && !code) return alert('Enter code');
  socket.emit('create-room', { name, isPublic, code });
  document.getElementById('createModal').classList.remove('active');
}
function openJoin() { document.getElementById('joinModal').classList.add('active'); }
function joinRoom(code) {
  if (!code) return alert('Enter code');
  socket.emit('join-room', code);
  document.getElementById('joinModal').classList.remove('active');
}

socket.on('room-created', ({ roomId }) => {
  myRoom = roomId; isHost = true;
  alert(`Room created!\nCode: ${roomId}`);
  startScreenShare();
});

socket.on('joined', ({ hostId }) => {
  myRoom = Array.from(socket.rooms).find(r => r !== socket.id);
  document.getElementById('playerContainer').classList.add('active');
  const pc = new RTCPeerConnection(config);
  peerConnections[hostId] = pc;
  pc.ontrack = e => document.getElementById('shareVideo').srcObject = e.streams[0];
  pc.onicecandidate = e => e.candidate && socket.emit('ice-candidate', { candidate: e.candidate, to: hostId });
});

socket.on('new-viewer', ({ viewerId }) => {
  if (!isHost) return;
  const pc = new RTCPeerConnection(config);
  peerConnections[viewerId] = pc;
  stream.getTracks().forEach(t => pc.addTrack(t, stream));
  pc.onicecandidate = e => e.candidate && socket.emit('ice-candidate', { candidate: e.candidate, to: viewerId });
  pc.createOffer().then(o => pc.setLocalDescription(o).then(() => socket.emit('offer', { offer: o, to: viewerId })));
});

socket.on('offer', async ({ offer, from }) => {
  const pc = peerConnections[from];
  await pc.setRemoteDescription(offer);
  const answer = await pc.createAnswer();
  await pc.setLocalDescription(answer);
  socket.emit('answer', { answer, to: from });
});

socket.on('answer', async ({ answer, from }) => {
  await peerConnections[from].setRemoteDescription(answer);
});

socket.on('ice-candidate', ({ candidate, from }) => {
  peerConnections[from]?.addIceCandidate(candidate);
});

socket.on('room-closed', () => { alert('Host left'); closePlayer(); });

async function startScreenShare() {
  try {
    stream = await navigator.mediaDevices.getDisplayMedia({ video: true, audio: true });
    document.getElementById('shareVideo').srcObject = stream;
    document.getElementById('playerContainer').classList.add('active');
  } catch { alert('Cancelled'); }
}

function closePlayer() {
  document.getElementById('playerContainer').classList.remove('active');
  if (stream) stream.getTracks().forEach(t => t.stop());
  Object.values(peerConnections).forEach(pc => pc.close());
  peerConnections = {};
  socket.emit('leave-room');
}

// Public rooms
setInterval(() => fetch('/api/public-rooms').then(r => r.json()).then(d => {
  document.getElementById('publicRoomsList').innerHTML = d.rooms.map(r => `
    <div class="room-item"><span>${r.name} (${r.count}/10)</span>
    <button onclick="joinRoom('${r.id}')">Join</button></div>
  `).join('');
}), 5000);

// ==================== YOUR FULL ORIGINAL MOVIE CODE (100% RESTORED) ====================
let currentMovies = [], selectedMovieId = null, selectedShow = null, authToken = null, episodeData = null;

const movieGrid = document.getElementById('movieGrid');
const passwordModal = document.getElementById('passwordModal');
const episodeModal = document.getElementById('episodeModal');
const playerContainer = document.getElementById('playerContainer');
const playerIframe = document.getElementById('playerIframe');

async function loadMovies() {
  movieGrid.innerHTML = '<p style="text-align:center;color:#aaa;">Loading...</p>';
  try {
    const res = await fetch(API + '/api/movies');
    const data = await res.json();
    if (!data.ok || !data.movies.length) {
      movieGrid.innerHTML = '<p style="text-align:center;color:#aaa;">No movies found.</p>';
      return;
    }
    currentMovies = data.movies;
    applyFilters();
  } catch (err) {
    movieGrid.innerHTML = '<p style="color:red;">Failed to load</p>';
  }
}

function applyFilters() {
  const active = document.querySelector('#filterTabs button.active')?.dataset.type || 'all';
  const search = document.getElementById('searchInput').value.toLowerCase();
  const filtered = currentMovies.filter(m => {
    if (active !== 'all' && m.type !== active) return false;
    if (search && !m.title.toLowerCase().includes(search)) return false;
    return true;
  });
  movieGrid.innerHTML = filtered.map(m => `
    <div class="movie-card" onclick="requestMoviePassword(${m.id}, '${m.title.replace(/'/g, "\\'")}', '${m.type}')">
      <img src="${m.image || 'https://via.placeholder.com/300x450?text=No+Poster'}" alt="${m.title}">
      <div class="movie-info"><h3>${m.title}</h3><p>${m.year || ''}</p></div>
    </div>
  `).join('') || '<p style="text-align:center;color:#aaa;">No results</p>';
}

function requestMoviePassword(movieId, title, type) {
  selectedMovieId = movieId;
  selectedShow = { id: movieId, title, type };
  document.getElementById('passwordMovieTitle').textContent = title;
  passwordModal.classList.add('active');
}

async function verifyMoviePassword() {
  const password = document.getElementById('moviePasswordInput').value;
  if (!password) return alert('Enter password');
  try {
    const res = await fetch(API + '/api/movies/' + selectedMovieId + '/authorize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    });
    const data = await res.json();
    if (data.ok) {
      authToken = data.token;
      if (selectedShow.type === 'movie') {
        const embedRes = await fetch(API + '/api/movies/' + selectedMovieId + '/embed', {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const embedData = await embedRes.json();
        if (embedData.ok) showPlayer(embedData.url);
        else alert('Error: ' + embedData.error);
      } else {
        await requestEpisodeSelection();
      }
    } else alert('Wrong password');
  } catch { alert('Failed'); }
}

async function requestEpisodeSelection() {
  const res = await fetch(API + '/api/movies/' + selectedMovieId + '/episodes');
  const data = await res.json();
  if (data.ok) {
    episodeData = data.seasons;
    const seasonSelect = document.getElementById('seasonSelect');
    seasonSelect.innerHTML = Object.keys(episodeData).sort((a,b)=>a-b).map(s => `<option value="${s}">Season ${s}</option>`).join('');
    updateEpisodeSelect();
    episodeModal.classList.add('active');
  }
}

function updateEpisodeSelect() {
  const season = document.getElementById('seasonSelect').value;
  const episodeSelect = document.getElementById('episodeSelect');
  episodeSelect.innerHTML = episodeData[season].map(ep => `<option value="${ep.episode}">Episode ${ep.episode} - ${ep.name}</option>`).join('');
}

async function playSelectedEpisode() {
  const season = document.getElementById('seasonSelect').value;
  const episode = document.getElementById('episodeSelect').value;
  const embedRes = await fetch(API + '/api/movies/' + selectedMovieId + '/embed', {
    headers: { Authorization: `Bearer ${authToken}` }
  });
  const embedData = await embedRes.json();
  if (embedData.ok) {
    showPlayer(`${embedData.url}/${season}/${episode}`);
    episodeModal.classList.remove('active');
  }
}

function showPlayer(url) {
  playerIframe.src = url;
  playerContainer.classList.add('active');
  passwordModal.classList.remove('active');
  document.getElementById('moviePasswordInput').value = '';
}

function closePlayer() {
  playerContainer.classList.remove('active');
  playerIframe.src = '';
}

// Events
document.getElementById('searchInput').addEventListener('input', applyFilters);
document.querySelectorAll('#filterTabs button').forEach(b => b.addEventListener('click', () => {
  document.querySelector('#filterTabs button.active')?.classList.remove('active');
  b.classList.add('active');
  applyFilters();
}));

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal.active, .player-container.active').forEach(m => m.classList.remove('active'));
  }
});

loadMovies();
</script>
</body>
</html>
