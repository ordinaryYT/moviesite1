<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ogmovie</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#000;color:#fff;font-family:Arial,sans-serif}
  header{text-align:center;padding:2rem;position:relative}
  h1{color:#e50914;font-size:2.5rem}
  #adminBtn{position:absolute;top:2rem;right:2rem;background:#e50914;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;font-weight:bold}
  #searchContainer{max-width:500px;margin:0 auto 2rem auto;padding:0 2rem}
  #searchInput{width:100%;padding:1rem;border-radius:8px;border:2px solid #333;background:#1a1a1a;color:#fff;font-size:1.1rem}
  #searchInput:focus{outline:none;border-color:#e50914}
  #movieGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1.5rem;padding:2rem;max-width:1400px;margin:0 auto}
  .movie-card{cursor:pointer;border-radius:12px;overflow:hidden;background:#1a1a1a;transition:.3s}
  .movie-card:hover{transform:scale(1.05);box-shadow:0 0 20px rgba(229,9,20,.5)}
  .movie-card img{width:100%;height:300px;object-fit:cover}
  .movie-info{padding:1rem;text-align:center}
  .movie-info h3{font-size:1.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .movie-info p{color:#aaa;font-size:.9rem}
  
  /* Modal Styles */
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#1a1a1a;padding:2rem;border-radius:12px;width:90%;max-width:400px;position:relative}
  .close-modal{position:absolute;top:10px;right:15px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer}
  .modal h2{margin-bottom:1.5rem;color:#e50914}
  .form-group{margin-bottom:1rem}
  .form-group label{display:block;margin-bottom:0.5rem;color:#ccc}
  .form-group input{width:100%;padding:0.75rem;border-radius:4px;border:1px solid #333;background:#333;color:#fff}
  .modal-btn{width:100%;padding:0.75rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;margin-top:1rem}
  
  /* Admin Panel Styles */
  #adminPanel{display:none;padding:2rem;max-width:1400px;margin:0 auto}
  #adminPanel.active{display:block}
  .admin-actions{margin-bottom:2rem;display:flex;gap:1rem}
  .admin-btn{padding:0.75rem 1.5rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold}
  .movie-list-admin{margin-top:2rem}
  .movie-item-admin{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#1a1a1a;margin-bottom:1rem;border-radius:8px}
  .movie-item-admin button{background:#ff4444;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer}
  
  /* Player Styles */
  .player-container{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:9999}
  .player-container.active{display:block}
  .close-btn{position:absolute;top:20px;right:20px;background:rgba(0,0,0,.7);color:white;border:none;width:50px;height:50px;border-radius:50%;font-size:2rem;cursor:pointer;z-index:10000}
  .player-wrapper{position:relative;width:100%;height:100%}
  #playerIframe{width:100%;height:100%;border:none}
  .iframe-overlay{position:absolute;top:5px;left:0;width:160px;height:55px;background:#000;z-index:3;display:flex;align-items:center;justify-content:center;font-weight:bold;color:rgba(255,255,255,.5);letter-spacing:2px;text-transform:uppercase;border-radius:8px;}
  
  /* Loading Screen Styles */
  #loadingScreen{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:10002;align-items:center;justify-content:center;flex-direction:column}
  #loadingScreen.active{display:flex}
  .loading-spinner{width:60px;height:60px;border:5px solid #333;border-top:5px solid #e50914;border-radius:50%;animation:spin 1s linear infinite;margin-bottom:1rem}
  .loading-text{color:#fff;font-size:1.2rem;text-align:center}
  @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
</style>
</head>
<body>

<header>
  <h1>ogmovie</h1>
  <button id="adminBtn">Admin</button>
</header>
<main>
  <div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Search for movies..." />
  </div>
  <div id="movieGrid"></div>
  <div id="adminPanel" class="admin-panel"></div>
</main>

<!-- Loading Screen -->
<div id="loadingScreen" class="loading-screen">
  <div class="loading-spinner"></div>
  <div class="loading-text">Loading Player...</div>
</div>

<!-- Admin Login Modal -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeLoginModal()">√ó</button>
    <h2>Admin Login</h2>
    <div class="form-group">
      <label for="adminPassword">Password:</label>
      <input type="password" id="adminPassword" placeholder="Enter admin password">
    </div>
    <button class="modal-btn" onclick="adminLogin()">Login</button>
  </div>
</div>

<!-- Add Movie Modal -->
<div id="addMovieModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeAddMovieModal()">√ó</button>
    <h2>Add Movie</h2>
    <div class="form-group">
      <label for="movieTitle">Movie Title:</label>
      <input type="text" id="movieTitle" placeholder="Enter movie title">
    </div>
    <div class="form-group">
      <label for="movieImdbId">IMDb ID (optional):</label>
      <input type="text" id="movieImdbId" placeholder="tt1234567">
    </div>
    <div class="form-group">
      <label for="moviePassword">Movie Password:</label>
      <input type="password" id="moviePassword" placeholder="Set a password for this movie">
    </div>
    <button class="modal-btn" onclick="addMovie()">Add Movie</button>
  </div>
</div>

<!-- Password Modal -->
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closePasswordModal()">√ó</button>
    <h2>Enter Password</h2>
    <p id="passwordMovieTitle" style="margin-bottom:1rem;color:#ccc"></p>
    <div class="form-group">
      <label for="moviePasswordInput">Password:</label>
      <input type="password" id="moviePasswordInput" placeholder="Enter movie password">
    </div>
    <button class="modal-btn" onclick="verifyMoviePassword()">Watch Movie</button>
  </div>
</div>

<!-- Player Container -->
<div id="playerContainer" class="player-container">
  <button class="close-btn" onclick="closePlayer()">X</button>
  <div class="player-wrapper">
    <iframe id="playerIframe" allowfullscreen allow="autoplay; fullscreen" referrerpolicy="no-referrer"></iframe>
    <div class="iframe-overlay">ogmovie</div>
  </div>
</div>

<script>
const API = location.origin + '/api';
const EMBED_BASE = 'https://multiembed.mov/?video_id=';
const movieGrid = document.getElementById('movieGrid');
const playerIframe = document.getElementById('playerIframe');
const playerContainer = document.getElementById('playerContainer');
const adminBtn = document.getElementById('adminBtn');
const adminPanel = document.getElementById('adminPanel');
const loginModal = document.getElementById('loginModal');
const addMovieModal = document.getElementById('addMovieModal');
const passwordModal = document.getElementById('passwordModal');
const loadingScreen = document.getElementById('loadingScreen');
const searchInput = document.getElementById('searchInput');
const watermarkElement = document.querySelector('.iframe-overlay');

let adminToken = null;
let currentMovies = [];
let selectedMovieId = null;
let loadingTimer = null;
let audioInterval = null;
let isMonitoring = false;
let audioDetected = false;
const LOADING_DURATION = 10000; // 10 seconds

// === Window Focus Detection ===
function startFocusDetection() {
  stopFocusDetection();
  isMonitoring = true;
  audioDetected = false;
  
  console.log('üéØ Starting FOCUS detection...');
  
  let lastFocusTime = 0;
  let focusCount = 0;
  
  // Detect when window loses focus (user clicked inside iframe)
  window.addEventListener('blur', handleWindowBlur);
  
  // Also detect mouse movements over iframe as fallback
  playerContainer.addEventListener('mousemove', handleMouseMove);
  
  try {
    // Audio detection
    const audioContext = new (window.AudioContext || window.webkitAudioContext)();
    const analyser = audioContext.createAnalyser();
    analyser.fftSize = 256;
    
    navigator.mediaDevices.getUserMedia({ audio: true, video: false })
      .then(function(stream) {
        const microphone = audioContext.createMediaStreamSource(stream);
        microphone.connect(analyser);
        
        const bufferLength = analyser.frequencyBinCount;
        const dataArray = new Uint8Array(bufferLength);
        
        audioInterval = setInterval(() => {
          if (!playerContainer.classList.contains('active') || !isMonitoring) {
            stopFocusDetection();
            return;
          }
          
          analyser.getByteFrequencyData(dataArray);
          
          // Calculate average volume
          let sum = 0;
          for (let i = 0; i < bufferLength; i++) {
            sum += dataArray[i];
          }
          const average = sum / bufferLength;
          
          // If audio detected, stop showing loading screens
          if (average > 10 && !audioDetected) {
            audioDetected = true;
            console.log('üîä AUDIO DETECTED - Stopping loading screens');
            hideLoadingScreen();
          }
          
        }, 200);
        
      })
      .catch(function(err) {
        console.log('Microphone access denied, using focus-only detection');
      });
      
  } catch (error) {
    console.log('Audio context failed, using focus-only detection');
  }
}

function handleWindowBlur() {
  if (!isMonitoring || audioDetected) return;
  
  // Window lost focus = user clicked inside iframe
  console.log('üñ±Ô∏è WINDOW BLUR - User clicked in iframe, showing loading screen');
  showLoadingScreen();
  
  // Reset timer for 10 seconds
  if (loadingTimer) {
    clearTimeout(loadingTimer);
  }
  loadingTimer = setTimeout(() => {
    if (isMonitoring && !audioDetected) {
      hideLoadingScreen();
    }
  }, LOADING_DURATION);
}

function handleMouseMove(e) {
  if (!isMonitoring || audioDetected) return;
  
  // If mouse moves over iframe area, assume interaction
  const iframeRect = playerIframe.getBoundingClientRect();
  if (e.clientX >= iframeRect.left && e.clientX <= iframeRect.right &&
      e.clientY >= iframeRect.top && e.clientY <= iframeRect.bottom) {
    
    console.log('üñ±Ô∏è MOUSE OVER IFRAME - Showing loading screen');
    showLoadingScreen();
    
    if (loadingTimer) {
      clearTimeout(loadingTimer);
    }
    loadingTimer = setTimeout(() => {
      if (isMonitoring && !audioDetected) {
        hideLoadingScreen();
      }
    }, LOADING_DURATION);
  }
}

function stopFocusDetection() {
  isMonitoring = false;
  audioDetected = false;
  window.removeEventListener('blur', handleWindowBlur);
  playerContainer.removeEventListener('mousemove', handleMouseMove);
  
  if (audioInterval) {
    clearInterval(audioInterval);
    audioInterval = null;
  }
  if (loadingTimer) {
    clearTimeout(loadingTimer);
    loadingTimer = null;
  }
  console.log('üõë Focus detection stopped');
}

function showLoadingScreen() {
  if (!loadingScreen.classList.contains('active')) {
    loadingScreen.classList.add('active');
    console.log('üì∫ Loading screen shown');
  }
}

function hideLoadingScreen() {
  if (loadingScreen.classList.contains('active')) {
    loadingScreen.classList.remove('active');
    console.log('üì∫ Loading screen hidden');
  }
}

// === Rest of your existing functions (search, admin, etc.) ===
// ... (keep all your existing search, admin, and movie functions the same)

// === Movie Playback ===
function requestMoviePassword(movieId, movieTitle) {
  selectedMovieId = movieId;
  document.getElementById('passwordMovieTitle').textContent = movieTitle;
  passwordModal.classList.add('active');
}

function closePasswordModal() {
  passwordModal.classList.remove('active');
  selectedMovieId = null;
}

async function verifyMoviePassword() {
  const password = document.getElementById('moviePasswordInput').value;
  if (!password) return alert('Please enter password');
  
  try {
    const res = await fetch(API + '/movies/' + selectedMovieId + '/authorize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    });
    const data = await res.json();
    if (data.ok) {
      const embedRes = await fetch(API + '/movies/' + selectedMovieId + '/embed', {
        headers: {
          'Authorization': `Bearer ${data.token}`
        }
      });
      const embedData = await embedRes.json();
      if (embedData.ok) {
        showPlayer(embedData.url);
      } else {
        alert('Error: ' + embedData.error);
      }
    } else {
      alert('Wrong password');
    }
  } catch (e) {
    console.error('Password verification failed', e);
    alert('Error verifying password');
  }
}

function showPlayer(embedUrl) {
  playerIframe.src = embedUrl;
  playerContainer.classList.add('active');
  passwordModal.classList.remove('active');
  document.getElementById('moviePasswordInput').value = '';
  
  // Start focus detection immediately
  startFocusDetection();
}

function closePlayer() {
  playerContainer.classList.remove('active');
  playerIframe.src = '';
  hideLoadingScreen();
  stopFocusDetection();
}

// === Initialize ===
loadMovies();
</script>
</body>
</html>
