<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ogmovie</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#000;color:#fff;font-family:Arial,sans-serif}
  header{text-align:center;padding:2rem;position:relative}
  h1{color:#e50914;font-size:2.5rem}
  #adminBtn{position:absolute;top:2rem;right:2rem;background:#e50914;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;font-weight:bold}
  #searchContainer{max-width:500px;margin:0 auto 2rem auto;padding:0 2rem}
  #searchInput{width:100%;padding:1rem;border-radius:8px;border:2px solid #333;background:#1a1a1a;color:#fff;font-size:1.1rem}
  #searchInput:focus{outline:none;border-color:#e50914}
  #movieGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1.5rem;padding:2rem;max-width:1400px;margin:0 auto}
  .movie-card{cursor:pointer;border-radius:12px;overflow:hidden;background:#1a1a1a;transition:.3s}
  .movie-card:hover{transform:scale(1.05);box-shadow:0 0 20px rgba(229,9,20,.5)}
  .movie-card img{width:100%;height:300px;object-fit:cover}
  .movie-info{padding:1rem;text-align:center}
  .movie-info h3{font-size:1.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .movie-info p{color:#aaa;font-size:.9rem}
  
  /* Modal Styles */
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#1a1a1a;padding:2rem;border-radius:12px;width:90%;max-width:400px;position:relative}
  .close-modal{position:absolute;top:10px;right:15px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer}
  .modal h2{margin-bottom:1.5rem;color:#e50914}
  .form-group{margin-bottom:1rem}
  .form-group label{display:block;margin-bottom:0.5rem;color:#ccc}
  .form-group input{width:100%;padding:0.75rem;border-radius:4px;border:1px solid #333;background:#333;color:#fff}
  .modal-btn{width:100%;padding:0.75rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;margin-top:1rem}
  
  /* Admin Panel Styles */
  #adminPanel{display:none;padding:2rem;max-width:1400px;margin:0 auto}
  #adminPanel.active{display:block}
  .admin-actions{margin-bottom:2rem;display:flex;gap:1rem}
  .admin-btn{padding:0.75rem 1.5rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold}
  .movie-list-admin{margin-top:2rem}
  .movie-item-admin{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#1a1a1a;margin-bottom:1rem;border-radius:8px}
  .movie-item-admin button{background:#ff4444;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer}
  
  /* Player Styles */
  .player-container{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:9999}
  .player-container.active{display:block}
  .close-btn{position:absolute;top:20px;right:20px;background:rgba(0,0,0,.7);color:white;border:none;width:50px;height:50px;border-radius:50%;font-size:2rem;cursor:pointer;z-index:10000}
  .player-wrapper{position:relative;width:100%;height:100%}
  #playerIframe{width:100%;height:100%;border:none}
  .iframe-overlay{position:absolute;top:5px;left:0;width:160px;height:55px;background:#000;z-index:3;display:flex;align-items:center;justify-content:center;font-weight:bold;color:rgba(255,255,255,.5);letter-spacing:2px;text-transform:uppercase;border-radius:8px;}
  /* ✅ Bottom overlay: solid black & half-width shift */
  .bottom-left-overlay {
    position: absolute;
    bottom: 10px;
    left: 60px; /* half-width shift to the right */
    width: 120px;
    height: 40px;
    background: #000; /* solid black */
    z-index: 10;
    border-radius: 8px;
  }
</style>
</head>
<body>

<header>
  <h1>ogmovie</h1>
  <button id="adminBtn">Admin</button>
</header>
<main>
  <div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Search for movies..." />
  </div>
  <div id="movieGrid"></div>
  <div id="adminPanel" class="admin-panel"></div>
</main>

<!-- Admin Login Modal -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeLoginModal()">×</button>
    <h2>Admin Login</h2>
    <div class="form-group">
      <label for="adminPassword">Password:</label>
      <input type="password" id="adminPassword" placeholder="Enter admin password">
    </div>
    <button class="modal-btn" onclick="adminLogin()">Login</button>
  </div>
</div>

<!-- Add Movie Modal -->
<div id="addMovieModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeAddMovieModal()">×</button>
    <h2>Add Movie</h2>
    <div class="form-group">
      <label for="movieTitle">Movie Title:</label>
      <input type="text" id="movieTitle" placeholder="Enter movie title">
    </div>
    <div class="form-group">
      <label for="movieImdbId">IMDb ID (optional):</label>
      <input type="text" id="movieImdbId" placeholder="tt1234567">
    </div>
    <div class="form-group">
      <label for="moviePassword">Movie Password:</label>
      <input type="password" id="moviePassword" placeholder="Set a password for this movie">
    </div>
    <div class="form-group">
      <label for="oneTimePassword">One-Time Password (optional):</label>
      <input type="password" id="oneTimePassword" placeholder="Set one-time password">
    </div>
    <button class="modal-btn" onclick="addMovie()">Add Movie</button>
  </div>
</div>

<!-- Password Modal -->
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closePasswordModal()">×</button>
    <h2>Enter Password</h2>
    <p id="passwordMovieTitle" style="margin-bottom:1rem;color:#ccc"></p>
    <div class="form-group">
      <label for="moviePasswordInput">Password:</label>
      <input type="password" id="moviePasswordInput" placeholder="Enter movie password">
    </div>
    <button class="modal-btn" onclick="verifyMoviePassword()">Watch Movie</button>
  </div>
</div>

<!-- Player Container -->
<div id="playerContainer" class="player-container">
  <button class="close-btn" onclick="closePlayer()">X</button>
  <div class="player-wrapper">
    <iframe id="playerIframe" allowfullscreen allow="autoplay; fullscreen" referrerpolicy="no-referrer"></iframe>
    <div class="iframe-overlay">ogmovie</div>
    <div class="bottom-left-overlay"></div>
  </div>
</div>
<script>
const API = window.location.origin + '/api';
const EMBED_BASE = 'https://vidsrc.me/embed/movie/';
const movieGrid = document.getElementById('movieGrid');
const playerIframe = document.getElementById('playerIframe');
const playerContainer = document.getElementById('playerContainer');
const adminBtn = document.getElementById('adminBtn');
const adminPanel = document.getElementById('adminPanel');
const loginModal = document.getElementById('loginModal');
const addMovieModal = document.getElementById('addMovieModal');
const passwordModal = document.getElementById('passwordModal');
const searchInput = document.getElementById('searchInput');

let adminToken = null;
let currentMovies = [];
let selectedMovieId = null;

// === Search ===
function filterMovies(term){
  const f=currentMovies.filter(m=>m.title.toLowerCase().includes(term.toLowerCase()));
  displayMovies(f);
}
function displayMovies(list){
  movieGrid.innerHTML='';
  if(!list.length){movieGrid.innerHTML='<p style="text-align:center;color:#aaa;grid-column:1/-1;">No movies found</p>';return;}
  list.forEach(createMovieCard);
}

// === Posters ===
async function getMoviePoster(title,year=''){
  try{
    const r=await fetch(`https://api.tvmaze.com/search/shows?q=${encodeURIComponent(title)}`);
    const d=await r.json();
    if(d.length&&d[0].show.image&&d[0].show.image.medium)return d[0].show.image.medium;
  }catch{}
  try{
    const r=await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title.replace(/ /g,'_'))}`);
    const d=await r.json();
    if(d.thumbnail&&d.thumbnail.source)return d.thumbnail.source;
  }catch{}
  return `https://via.placeholder.com/300x450/333/fff?text=${encodeURIComponent(title.substring(0,20))}`;
}
async function createMovieCard(m){
  try{
    let img=m.image;const y=m.year||'N/A';const p=await getMoviePoster(m.title,y);
    if(!p.includes('placeholder.com'))img=p;
    const c=document.createElement('div');c.className='movie-card';
    c.innerHTML=`<img src="${img}" onerror="this.src='https://via.placeholder.com/300x450/333/fff?text=No+Poster'"><div class="movie-info"><h3>${m.title}</h3><p>${y}</p></div>`;
    c.onclick=()=>requestMoviePassword(m.id,m.title);
    movieGrid.appendChild(c);
  }catch(e){console.error(e);}
}

// === Admin ===
function openAdminPanel(){loginModal.classList.add('active');}
function closeLoginModal(){loginModal.classList.remove('active');}
function closeAddMovieModal(){addMovieModal.classList.remove('active');}

async function adminLogin(){
  const pw=document.getElementById('adminPassword').value;
  if(!pw)return alert('Please enter password');
  try{
    const r=await fetch(API+'/admin/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pw})});
    const d=await r.json();
    if(d.ok){adminToken=d.token;loginModal.classList.remove('active');showAdminPanel();loadAdminMovies();}
    else alert('Invalid password');
  }catch{alert('Login failed');}
}
function showAdminPanel(){
  movieGrid.style.display='none';
  adminPanel.classList.add('active');
  adminPanel.innerHTML=`<h2>Admin Panel</h2>
  <div class="admin-actions">
  <button class="admin-btn" onclick="openAddMovieModal()">Add Movie</button>
  <button class="admin-btn" onclick="exitAdmin()">Exit Admin</button></div>
  <div class="movie-list-admin" id="movieListAdmin"></div>`;
}
function exitAdmin(){adminToken=null;adminPanel.classList.remove('active');movieGrid.style.display='grid';}
function openAddMovieModal(){addMovieModal.classList.add('active');}

async function addMovie(){
  const t=document.getElementById('movieTitle').value;
  const i=document.getElementById('movieImdbId').value;
  const p=document.getElementById('moviePassword').value;
  const o=document.getElementById('oneTimePassword').value;
  if((!t&&!i)||!p)return alert('Please provide movie title or IMDb ID and password');
  try{
    const r=await fetch(API+'/movies',{method:'POST',headers:{'Content-Type':'application/json','Authorization':`Bearer ${adminToken}`},
      body:JSON.stringify({name:t,imdbId:i,moviePassword:p,oneTimePassword:o||null})});
    const d=await r.json();
    if(d.ok){alert('Movie added');closeAddMovieModal();loadAdminMovies();loadMovies();}
    else alert('Error: '+d.error);
  }catch{alert('Failed to add');}
}

async function loadAdminMovies(){
  try{
    const r=await fetch(API+'/movies');const d=await r.json();
    if(d.ok){
      currentMovies=d.movies;
      const L=document.getElementById('movieListAdmin');L.innerHTML='<h3>Movies</h3>';
      d.movies.forEach(m=>{
        const e=document.createElement('div');e.className='movie-item-admin';
        e.innerHTML=`<div><strong>${m.title}</strong> ${m.year?`(${m.year})`:''}</div><button onclick="deleteMovie(${m.id})">Delete</button>`;
        L.appendChild(e);
      });
    }
  }catch{}
}
async function deleteMovie(id){
  if(!confirm('Delete movie?'))return;
  try{
    const r=await fetch(API+'/movies/'+id,{method:'DELETE',headers:{'Authorization':`Bearer ${adminToken}`}});
    const d=await r.json();
    if(d.ok){loadAdminMovies();loadMovies();}else alert('Error: '+d.error);
  }catch{alert('Delete failed');}
}

// === Playback ===
function requestMoviePassword(id,title){
  selectedMovieId=id;
  document.getElementById('passwordMovieTitle').textContent=title;
  passwordModal.classList.add('active');
}
function closePasswordModal(){passwordModal.classList.remove('active');selectedMovieId=null;}

async function verifyMoviePassword(){
  const pw=document.getElementById('moviePasswordInput').value;
  if(!pw)return alert('Please enter password');
  try{
    const r=await fetch(API+'/movies/'+selectedMovieId+'/authorize',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pw})});
    const d=await r.json();
    if(d.ok){
      const e=await fetch(API+'/movies/'+selectedMovieId+'/embed',{headers:{'Authorization':`Bearer ${d.token}`}});
      const x=await e.json();
      if(x.ok)showPlayer(x.url);else alert('Error: '+x.error);
    }else alert('Wrong password');
  }catch{alert('Verify failed');}
}
function showPlayer(u){
  playerIframe.src=u;
  playerContainer.classList.add('active');
  passwordModal.classList.remove('active');
  document.getElementById('moviePasswordInput').value='';
}
function closePlayer(){
  playerContainer.classList.remove('active');
  playerIframe.src='';
}

// === Load Movies ===
async function loadMovies(){
  movieGrid.innerHTML='<p style="text-align:center;color:#aaa;">Loading...</p>';
  try{
    const r=await fetch(API+'/movies');const d=await r.json();
    if(!d.ok||!d.movies.length){movieGrid.innerHTML='<p style="text-align:center;color:#aaa;">No movies found.</p>';return;}
    currentMovies=d.movies;displayMovies(currentMovies);
  }catch{
    movieGrid.innerHTML='<p style="color:red;text-align:center;">Error loading movies.</p>';
  }
}

// === Events ===
adminBtn.addEventListener('click',openAdminPanel);
searchInput.addEventListener('input',e=>filterMovies(e.target.value));
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){closePlayer();closeLoginModal();closeAddMovieModal();closePasswordModal();}
});
loadMovies();
</script>
</body>
</html>
