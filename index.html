<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>ogmovie – Netflix</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css2?family=Netflix+Sans:wght@400;700&display=swap" rel="stylesheet">
<style>
  :root{--red:#e50914;--black:#141414;--dark:#221f1f;--bg:#000;--text:#fff;--muted:#b3b3b3;--card:#2f2f2f}
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:var(--bg);color:var(--text);font-family:'Netflix Sans',Arial,sans-serif;overflow-x:hidden}
  header{position:fixed;top:0;left:0;right:0;padding:1rem 4%;display:flex;align-items:center;justify-content:space-between;z-index:1000;transition:background .3s}
  header.scrolled{background:rgba(20,20,20,.95);backdrop-filter:blur(10px)}
  .logo{font-size:2rem;font-weight:700;color:var(--red)}
  .nav a{margin-left:1.5rem;color:var(--text);text-decoration:none;font-weight:500}
  .nav a:hover{color:var(--red)}
  #adminBtn{background:var(--red);border:none;padding:.4rem 1rem;border-radius:4px;cursor:pointer;font-weight:600}
  .search-wrapper{position:relative;display:flex;align-items:center;background:rgba(0,0,0,.6);border-radius:4px;padding:0 .5rem;width:40px;transition:width .4s}
  .search-wrapper.active{width:300px}
  #searchInput{background:none;border:none;color:#fff;width:100%;padding:.5rem 0;font-size:1rem;outline:none}
  .search-icon{color:#fff;cursor:pointer;font-size:1.2rem}
  .hero{height:90vh;position:relative;overflow:hidden;background-size:cover;background-position:center}
  .hero::after{content:"";position:absolute;inset:0;background:linear-gradient(to top,rgba(0,0,0,.8),transparent 30%,rgba(0,0,0,.8))}
  .hero-content{position:absolute;bottom:20%;left:4%;max-width:45%;z-index:2}
  .hero h1{font-size:3.5rem;margin-bottom:.5rem}
  .hero p{font-size:1.2rem;margin-bottom:1rem}
  .hero button{background:var(--red);border:none;padding:.8rem 1.8rem;border-radius:4px;font-weight:600;cursor:pointer;font-size:1rem}
  .row{padding:2rem 4%}
  .row-title{font-size:1.4rem;margin-bottom:.8rem}
  .row-scroller{display:flex;gap:10px;overflow-x:auto;scroll-behavior:smooth;padding-bottom:1rem}
  .row-scroller::-webkit-scrollbar{display:none}
  .card{flex:0 0 200px;position:relative;cursor:pointer;border-radius:8px;overflow:hidden;transition:transform .3s}
  .card:hover{transform:scale(1.07);z-index:2}
  .card img{width:100%;display:block}
  .card-info{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(transparent,rgba(0,0,0,.8));padding:.5rem;color:#fff;opacity:0;transition:opacity .3s}
  .card:hover .card-info{opacity:1}
  .card-title{font-size:1rem;font-weight:600}
  .card-year{font-size:.85rem;color:var(--muted)}
  .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.9);align-items:center;justify-content:center;z-index:2000}
  .modal.active{display:flex}
  .modal-box{background:var(--dark);padding:2rem;border-radius:12px;width:90%;max-width:460px;position:relative}
  .close-modal{position:absolute;top:10px;right:15px;background:none;border:none;color:#fff;font-size:1.8rem;cursor:pointer}
  .modal h2{color:var(--red);margin-bottom:1rem}
  .form-group{margin-bottom:1rem}
  .form-group label{display:block;margin-bottom:.4rem;color:#ccc}
  .form-group input,.form-group select{width:100%;padding:.75rem;border-radius:4px;border:none;background:#333;color:#fff}
  .modal-btn{width:100%;padding:.75rem;background:var(--red);color:#fff;border:none;border-radius:4px;cursor:pointer;font-weight:600;margin-top:1rem}
  .player-container{display:none;position:fixed;inset:0;background:#000;z-index:9999}
  .player-container.active{display:block}
  .close-btn{position:absolute;top:20px;right:20px;background:rgba(0,0,0,.6);color:#fff;width:48px;height:48px;border-radius:50%;font-size:1.8rem;border:none;cursor:pointer}
  #playerIframe{width:100%;height:100%;border:none}
  .iframe-overlay{position:absolute;top:12px;left:12px;background:rgba(0,0,0,.7);padding:.4rem .8rem;border-radius:4px;font-size:.9rem;color:#aaa;letter-spacing:1px}
  #loadingScreen{display:none;position:fixed;inset:0;background:#000;z-index:10001;align-items:center;justify-content:center;flex-direction:column}
  #loadingScreen.active{display:flex}
  .spinner{width:60px;height:60px;border:6px solid #222;border-top:6px solid var(--red);border-radius:50%;animation:s 1s linear infinite;margin-bottom:1rem}
  @keyframes s{to{transform:rotate(360deg)}}
</style>
</head>
<body>

<header id="header">
  <div class="logo">ogmovie</div>
  <nav class="nav">
    <a href="#" id="homeLink">Home</a>
    <a href="#" id="tvLink">TV Shows</a>
    <a href="#" id="movieLink">Movies</a>
  </nav>
  <div class="search-wrapper" id="searchWrapper">
    <span class="search-icon" id="searchToggle">Search</span>
    <input type="text" id="searchInput" placeholder="Search titles...">
  </div>
  <button id="adminBtn">Admin</button>
</header>

<div class="hero" id="hero">
  <div class="hero-content">
    <h1 id="heroTitle"></h1>
    <p id="heroDesc"></p>
    <button id="heroPlay">Play</button>
  </div>
</div>

<main style="margin-top:-100px;position:relative;z-index:2">
  <section class="row" id="rowFeatured"><div class="row-title">Featured</div><div class="row-scroller" id="featuredScroller"></div></section>
  <section class="row" id="rowTV"><div class="row-title">TV Shows</div><div class="row-scroller" id="tvScroller"></div></section>
  <section class="row" id="rowMovies"><div class="row-title">Movies</div><div class="row-scroller" id="movieScroller"></div></section>
</main>

<div id="loadingScreen"><div class="spinner"></div><div>Loading Player…</div></div>

<div id="loginModal" class="modal">
  <div class="modal-box">
    <button class="close-modal" onclick="closeLoginModal()">X</button>
    <h2>Admin Login</h2>
    <div class="form-group"><label>Password</label><input type="password" id="adminPassword"></div>
    <button class="modal-btn" onclick="adminLogin()">Login</button>
  </div>
</div>

<div id="addMovieModal" class="modal">
  <div class="modal-box">
    <button class="close-modal" onclick="closeAddMovieModal()">X</button>
    <h2 id="addMovieTitle">Add Movie</h2>
    <div class="form-group"><label>Title</label><input type="text" id="movieTitle"></div>
    <div class="form-group"><label>IMDb ID (optional)</label><input type="text" id="movieImdbId" placeholder="tt1234567"></div>
    <div class="form-group"><label>Password</label><input type="password" id="moviePassword"></div>
    <div class="form-group"><label>Category</label>
      <select id="movieCategory">
        <option value="movie">Movie</option>
        <option value="tv">TV Show</option>
        <option value="featured">Featured (Hero)</option>
      </select>
    </div>
    <button class="modal-btn" onclick="saveMovie()">Save</button>
  </div>
</div>

<div id="passwordModal" class="modal">
  <div class="modal-box">
    <button class="close-modal" onclick="closePasswordModal()">X</button>
    <h2>Enter Password</h2>
    <p id="passwordMovieTitle" style="margin-bottom:1rem;color:#ccc"></p>
    <div class="form-group"><label>Password</label><input type="password" id="moviePasswordInput"></div>
    <button class="modal-btn" onclick="verifyMoviePassword()">Watch</button>
  </div>
</div>

<div id="playerContainer" class="player-container">
  <button class="close-btn" onclick="closePlayer()">X</button>
  <iframe id="playerIframe" allowfullscreen allow="autoplay; fullscreen"></iframe>
  <div class="iframe-overlay">ogmovie</div5</div>
</div>

<script>
/* ==== ALL YOUR ORIGINAL CODE (unchanged) ==== */
const API = location.origin + '/api';
const EMBED_BASE = 'https://multiembed.mov/?video_id=';
const movieGrid = {innerHTML:''}; // dummy – we use rows now
const playerIframe = document.getElementById('playerIframe');
const playerContainer = document.getElementById('playerContainer');
const adminBtn = document.getElementById('adminBtn');
const adminPanel = {innerHTML:''}; // dummy
const loginModal = document.getElementById('loginModal');
const addMovieModal = document.getElementById('addMovieModal');
const passwordModal = document.getElementById('passwordModal');
const loadingScreen = document.getElementById('loadingScreen');
const searchInput = document.getElementById('searchInput');

let adminToken = null;
let currentMovies = [];
let selectedMovieId = null;
let loadingTimer = null;
let clickCount = 0;
const MAX_LOADING_CLICKS = 5;
const LOADING_DURATION = 10000;

/* ---- ORIGINAL SEARCH ---- */
function filterMovies(searchTerm) {
  const filtered = currentMovies.filter(m=>m.title.toLowerCase().includes(searchTerm.toLowerCase()));
  renderRows(filtered);
}
searchInput.addEventListener('input', e=>filterMovies(e.target.value));

/* ---- ORIGINAL IMAGE FALLBACK ---- */
async function getMoviePoster(movieTitle, year=''){
  try{
    const r=await fetch(`https://api.tvmaze.com/search/shows?q=${encodeURIComponent(movieTitle)}`);
    const d=await r.json();
    if(d[0]?.show?.image?.medium) return d[0].show.image.medium;
  }catch{}
  return `https://via.placeholder.com/300x450/333/fff?text=${encodeURIComponent(movieTitle.substring(0,20))}`;
}

/* ---- CARD CREATOR (used in rows) ---- */
async function createMovieCard(movie){
  let img = movie.image||await getMoviePoster(movie.title,movie.year);
  const card=document.createElement('div');
  card.className='card';
  card.innerHTML=`
    <img src="${img}" onerror="this.src='https://via.placeholder.com/300x450/333/fff?text=No+Poster'">
    <div class="card-info"><div class="card-title">${movie.title}</div><div class="card-year">${movie.year||''}</div></div>`;
  card.onclick=()=>requestMoviePassword(movie.id,movie.title);
  return card;
}

/* ---- RENDER ROWS (Featured / TV / Movies) ---- */
async function renderRows(movies){
  currentMovies = movies;
  const featured = movies.filter(m=>m.category==='featured');
  const tv = movies.filter(m=>m.category==='tv');
  const mov = movies.filter=m=>!['featured','tv'].includes(m.category));

  // Hero
  const heroMovie = featured[0] || movies[0];
  if(heroMovie){
    const heroImg = heroMovie.image||await getMoviePoster(heroMovie.title);
    document.getElementById('hero').style.backgroundImage=`url(${heroImg})`;
    document.getElementById('heroTitle').textContent=heroMovie.title;
    document.getElementById('heroDesc').textContent=`${heroMovie.year||'N/A'}`;
    document.getElementById('heroPlay').onclick=()=>requestMoviePassword(heroMovie.id,heroMovie.title);
  }

  // Rows
  await fillRow('featuredScroller',featured.slice(0,12));
  await fillRow('tvScroller',tv.slice(0,12));
  await fillRow('movieScroller',mov.slice(0,12));
}
async function fillRow(id,list){
  const scroller=document.getElementById(id);
  scroller.innerHTML='';
  for(const m of list) scroller.appendChild(await createMovieCard(m));
}

/* ---- LOAD MOVIES ---- */
async function loadMovies(){
  try{
    const r=await fetch(API+'/movies');
    const d=await r.json();
    if(!d.ok||!d.movies.length) return;
    renderRows(d.movies);
  }catch(e){console.error(e);}
}
loadMovies();

/* ---- ADMIN (your original functions) ---- */
function openAdminPanel(){ loginModal.classList.add('active'); }
function closeLoginModal(){ loginModal.classList.remove('active'); }
function closeAddMovieModal(){ addMovieModal.classList.remove('active'); }

async function adminLogin(){
  const pwd=document.getElementById('adminPassword').value;
  if(!pwd) return alert('Password required');
  const r=await fetch(API+'/admin/login',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pwd})});
  const d=await r.json();
  if(!d.ok) return alert('Invalid password');
  adminToken=d.token;
  closeLoginModal();
  showAdminPanel();
}
function showAdminPanel(){
  document.querySelector('main').innerHTML=`
    <div style="padding:2rem 4%;max-width:1200px;margin:auto">
      <h2 style="color:var(--red)">Admin Panel</h2>
      <button class="modal-btn" onclick="openAddMovieModal()" style="width:auto;padding:.6rem 1.2rem">Add New</button>
      <button class="modal-btn" onclick="exitAdmin()" style="width:auto;margin-left:.5rem;background:#555">Exit</button>
      <div id="adminList" style="margin-top:2rem"></div>
    </div>`;
  loadAdminMovies();
}
function exitAdmin(){ adminToken=null; location.reload(); }

function openAddMovieModal(movie=null){
  editingMovie=movie;
  document.getElementById('addMovieTitle').textContent=movie?'Edit Movie':'Add Movie';
  document.getElementById('movieTitle').value=movie?.title||'';
  document.getElementById('movieImdbId').value=movie?.imdb_id||'';
  document.getElementById('moviePassword').value='';
  document.getElementById('movieCategory').value=movie?.category||'movie';
  addMovieModal.classList.add('active');
}
let editingMovie=null;

async function saveMovie(){
  const title=document.getElementById('movieTitle').value.trim();
  const imdb=document.getElementById('movieImdbId').value.trim();
  const pwd=document.getElementById('moviePassword').value;
  const cat=document.getElementById('movieCategory').value;
  if((!title && !imdb) || !pwd) return alert('Title/IMDb + password required');

  const payload={name:title,imdbId:imdb,moviePassword:pwd,category:cat};
  if(editingMovie) payload.id=editingMovie.id;

  const url=editingMovie?API+`/movies/${editingMovie.id}`:API+'/movies';
  const method=editingMovie?'PUT':'POST';

  const r=await fetch(url,{method,headers:{'Content-Type':'application/json','Authorization':`Bearer ${adminToken}`},body:JSON.stringify(payload)});
  const d=await r.json();
  if(!d.ok) return alert(d.error||'Failed');
  alert(editingMovie?'Updated!':'Added!');
  closeAddMovieModal();
  loadAdminMovies();
  loadMovies();
}

async function loadAdminMovies(){
  const r=await fetch(API+'/movies');
  const d=await r.json();
  const list=document.getElementById('adminList');
  list.innerHTML='<h3 style="margin:1rem 0">All Movies</h3>';
  d.movies.forEach(m=>{
    const div=document.createElement('div');
    div.style.cssText='display:flex;justify-content:space-between;align-items:center;background:#222;padding:1rem;margin-bottom:.5rem;border-radius:6px';
    div.innerHTML=`
      <div><strong>${m.title}</strong> ${m.year?`(${m.year})`:''} <span style="margin-left:1rem;color:#0f0">[${m.category||'movie'}]</span></div>
      <div>
        <button style="background:#e50914;padding:.4rem .8rem;border:none;color:#fff;border-radius:4px;cursor:pointer;margin-right:.5rem" onclick='openAddMovieModal(${JSON.stringify(m)})'>Edit</button>
        <button style="background:#c00;padding:.4rem .8rem;border:none;color:#fff;border-radius:4px;cursor:pointer" onclick="deleteMovie(${m.id})">Delete</button>
      </div>`;
    list.appendChild(div);
  });
}
async function deleteMovie(id){
  if(!confirm('Delete this movie?')) return;
  const r=await fetch(API+`/movies/${id}`,{method:'DELETE',headers:{'Authorization':`Bearer ${adminToken}`}});
  const d=await r.json();
  if(d.ok){loadAdminMovies();loadMovies();}
  else alert(d.error||'Failed');
}

/* ---- PASSWORD & PLAY (your original) ---- */
function requestMoviePassword(id,title){
  selectedMovieId=id;
  document.getElementById('passwordMovieTitle').textContent=title;
  passwordModal.classList.add('active');
}
function closePasswordModal(){
  passwordModal.classList.remove('active');
  selectedMovieId=null;
}
async function verifyMoviePassword(){
  const pwd=document.getElementById('moviePasswordInput').value;
  if(!pwd) return alert('Enter password');
  try{
    const r=await fetch(API+`/movies/${selectedMovieId}/authorize`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({password:pwd})});
    const d=await r.json();
    if(!d.ok) throw d.error||'Wrong password';
    const er=await fetch(API+`/movies/${selectedMovieId}/embed`,{headers:{'Authorization':`Bearer ${d.token}`}});
    const ed=await er.json();
    if(!ed.ok) throw ed.error;
    showPlayer(ed.url);
  }catch(e){alert(e);}
}

/* ---- PLAYER (your original) ---- */
function showPlayer(embedUrl){
  clickCount=0;
  playerIframe.src=embedUrl;
  playerContainer.classList.add('active');
  passwordModal.classList.remove('active');
  document.getElementById('moviePasswordInput').value='';

  let interaction=false;
  const handle=()=>{if(!interaction && clickCount<MAX_LOADING_CLICKS){interaction=true;clickCount++;showLoadingScreen();setTimeout(()=>{interaction=false},1000);}}
  window.addEventListener('blur',handle);
  playerContainer.addEventListener('click',handle);
  playerContainer.addEventListener('mousedown',handle);
  playerContainer._clean=()=>{window.removeEventListener('blur',handle);playerContainer.removeEventListener('click',handle);playerContainer.removeEventListener('mousedown',handle);};

  playerIframe.onload=()=>{setTimeout(()=>{try{const w=playerIframe.contentWindow;w.open=u=>{(const c=document.createElement('iframe')).style.display='none';c.src=u||'about:blank';document.body.appendChild(c);return c.contentWindow;}}catch{}},1000);};
}
function showLoadingScreen(){
  loadingScreen.classList.add('active');
  loadingTimer=setTimeout(hideLoadingScreen,LOADING_DURATION);
}
function hideLoadingScreen(){loadingScreen.classList.remove('active');}
function closePlayer(){
  playerContainer.classList.remove('active');
  playerIframe.src='';
  hideLoadingScreen();
  if(playerContainer._clean) playerContainer._clean();
}

/* ---- NAV FILTERS ---- */
document.getElementById('homeLink').onclick=e=>{e.preventDefault();renderRows(currentMovies);}
document.getElementById('tvLink').onclick=e=>{e.preventDefault();renderRows(currentMovies.filter(m=>m.category==='tv'));}
document.getElementById('movieLink').onclick=e=>{e.preventDefault();renderRows(currentMovies.filter(m=>!['featured','tv'].includes(m.category)));}

/* ---- UI HELPERS ---- */
window.addEventListener('scroll',()=>document.getElementById('header').classList.toggle('scrolled',window.scrollY>50));
document.getElementById('searchToggle').onclick=()=>document.getElementById('searchWrapper').classList.toggle('active');
adminBtn.addEventListener('click',openAdminPanel);
document.addEventListener('keydown',e=>{if(e.key==='Escape'){closePlayer();closePasswordModal();closeLoginModal();closeAddMovieModal();}});
</script>
</body>
</html>
