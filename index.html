<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ogmovie</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#000;color:#fff;font-family:Arial,sans-serif}
  header{text-align:center;padding:2rem;position:relative}
  h1{color:#e50914;font-size:2.5rem}
  #adminBtn{position:absolute;top:2rem;right:2rem;background:#e50914;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;font-weight:bold}
  #searchContainer{max-width:500px;margin:0 auto 1rem auto;padding:0 2rem}
  #searchInput{width:100%;padding:1rem;border-radius:8px;border:2px solid #333;background:#1a1a1a;color:#fff;font-size:1.1rem}
  #searchInput:focus{outline:none;border-color:#e50914}

  /* NEW: Filter tabs */
  .filter-tabs{display:flex;justify-content:center;gap:1rem;margin-bottom:1.5rem;flex-wrap:wrap}
  .filter-tab{padding:0.5rem 1rem;background:#1a1a1a;border-radius:6px;cursor:pointer;transition:.3s}
  .filter-tab.active{background:#e50914}

  /* NEW: Sections */
  .section{margin-bottom:3rem}
  .section h2{margin-bottom:1rem;color:#e50914;padding:0 2rem}
  #movieGrid, .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1.5rem;padding:0 2rem;max-width:1400px;margin:0 auto}

  .movie-card{position:relative;cursor:pointer;border-radius:12px;overflow:hidden;background:#1a1a1a;transition:.3s}
  .movie-card:hover{transform:scale(1.05);box-shadow:0 0 20px rgba(229,9,20,.5)}
  .movie-card img{width:100%;height:300px;object-fit:cover}
  .movie-info{padding:1rem;text-align:center}
  .movie-info h3{font-size:1.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .movie-info p{color:#aaa;font-size:.9rem}

  /* NEW: Fav button */
  .fav-btn{position:absolute;top:10px;right:10px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer}
  .fav-btn.active{color:#e50914}

  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#1a1a1a;padding:2rem;border-radius:12px;width:90%;max-width:400px;position:relative}
  .close-modal{position:absolute;top:10px;right:15px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer}
  .modal h2{margin-bottom:1.5rem;color:#e50914}
  .form-group{margin-bottom:1rem}
  .form-group label{display:block;margin-bottom:0.5rem;color:#ccc}
  .form-group input{width:100%;padding:0.75rem;border-radius:4px;border:1px solid #333;background:#333;color:#fff}
  .form-group select{width:100%;padding:0.75rem;border-radius:4px;border:1px solid #333;background:#333;color:#fff}
  .modal-btn{width:100%;padding:0.75rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;margin-top:1rem}
  #adminPanel{display:none;padding:2rem;max-width:1400px;margin:0 auto}
  #adminPanel.active{display:block}
  .admin-actions{margin-bottom:2rem;display:flex;gap:1rem}
  .admin-btn{padding:0.75rem 1.5rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold}
  .movie-list-admin{margin-top:2rem}
  .movie-item-admin{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#1a1a1a;margin-bottom:1rem;border-radius:8px}
  .movie-item-admin button{background:#ff4444;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer}
  .player-container{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:999}
  .player-container.active{display:block}
  .close-btn{position:absolute;top:10px;right:10px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;z-index:1001}
  .player-wrapper{position:relative;width:100%;height:100%}
  #playerIframe{width:100%;height:100%;border:none}
  .iframe-overlay{position:absolute;top:5px;left:0;width:160px;height:55px;background:#000;z-index:3;display:flex;align-items:center;justify-content:center;font-weight:bold;color:rgba(255,255,255,.5);letter-spacing:2px;text-transform:uppercase;border-radius:8px;}
  .bottom-left-overlay{position:absolute;bottom:10px;left:200px;width:120px;height:40px;background:#000;z-index:10;border-radius:8px;}
</style>
</head>
<body>
<header>
  <h1>ogmovie</h1>
  <button id="adminBtn">Admin</button>
</header>
<main>
  <div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Search for movies or TV shows..." />
  </div>

  <!-- NEW: Filter tabs -->
  <div class="filter-tabs">
    <div class="filter-tab active" data-filter="movies">Movies</div>
    <div class="filter-tab" data-filter="tv">TV Shows</div>
    <div class="filter-tab" data-filter="favorites">Favorites</div>
  </div>

  <!-- NEW: Sections -->
  <div id="movieSection" class="section">
    <div id="movieGrid"></div>
  </div>
  <div id="tvSection" class="section" style="display:none">
    <div id="tvGrid" class="grid"></div>
  </div>
  <div id="favoritesSection" class="section" style="display:none">
    <div id="favoritesGrid" class="grid"></div>
  </div>

  <div id="adminPanel" class="admin-panel"></div>
</main>
<div id="loginModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeLoginModal()">×</button>
    <h2>Admin Login</h2>
    <div class="form-group">
      <label for="adminPassword">Password:</label>
      <input type="password" id="adminPassword" placeholder="Enter admin password">
    </div>
    <button class="modal-btn" onclick="adminLogin()">Login</button>
  </div>
</div>
<div id="addMovieModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeAddMovieModal()">×</button>
    <h2>Add Content</h2>
    <div class="form-group">
      <label for="movieTitle">Title:</label>
      <input type="text" id="movieTitle" placeholder="Enter movie or TV show title">
    </div>
    <div class="form-group">
      <label for="movieImdbId">IMDb ID (optional):</label>
      <input type="text" id="movieImdbId" placeholder="tt1234567">
    </div>
    <div class="form-group">
      <label for="contentType">Type:</label>
      <select id="contentType">
        <option value="movie">Movie</option>
        <option value="tv_show">TV Show</option>
      </select>
    </div>
    <div class="form-group">
      <label for="moviePassword">Passwords (comma-separated):</label>
      <input type="text" id="moviePassword" placeholder="pass1,pass2,...">
    </div>
    <div class="form-group">
      <label for="oneTimePassword">One-Time Passwords (comma-separated, optional):</label>
      <input type="text" id="oneTimePassword" placeholder="otp1,otp2,...">
    </div>
    <!-- ADDED: SUBTITLES CHECKBOX -->
    <div class="form-group">
      <label>
        <input type="checkbox" id="subtitlesEnabled"> Enable Subtitles (default: off)
      </label>
    </div>
    <button class="modal-btn" onclick="addMovie()">Add Content</button>
  </div>
</div>
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closePasswordModal()">×</button>
    <h2>Enter Password</h2>
    <p id="passwordMovieTitle" style="margin-bottom:1rem;color:#ccc"></p>
    <div class="form-group">
      <label for="moviePasswordInput">Password:</label>
      <input type="password" id="moviePasswordInput" placeholder="Enter password">
    </div>
    <button class="modal-btn" onclick="verifyMoviePassword()">Watch</button>
  </div>
</div>
<div id="globalPasswordModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeGlobalPasswordModal()">×</button>
    <h2>Add Global Password</h2>
    <div class="form-group">
      <label for="globalPassword">Password:</label>
      <input type="password" id="globalPassword" placeholder="Enter global password">
    </div>
    <div class="form-group">
      <label for="isOneTime">One-Time Password:</label>
      <input type="checkbox" id="isOneTime">
    </div>
    <button class="modal-btn" onclick="addGlobalPassword()">Add Global Password</button>
  </div>
</div>
<div id="episodeModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeEpisodeModal()">×</button>
    <h2>Select Episode</h2>
    <p id="episodeShowTitle" style="margin-bottom:1rem;color:#ccc"></p>
    <div class="form-group">
      <label for="seasonSelect">Season:</label>
      <select id="seasonSelect" onchange="updateEpisodeSelect()"></select>
    </div>
    <div class="form-group">
      <label for="episodeSelect">Episode:</label>
      <select id="episodeSelect"></select>
    </div>
    <button class="modal-btn" onclick="playSelectedEpisode()">Watch Episode</button>
  </div>
</div>
<div id="playerContainer" class="player-container">
  <button class="close-btn" onclick="closePlayer()">X</button>
  <div class="player-wrapper">
    <iframe id="playerIframe" allowfullscreen allow="autoplay; fullscreen" referrerpolicy="no-referrer"></iframe>
    <div class="iframe-overlay">ogmovie</div>
    <div class="bottom-left-overlay"></div>
  </div>
</div>
<script>
const API = window.location.origin + '/api';
const movieGrid = document.getElementById('movieGrid');
const tvGrid = document.getElementById('tvGrid');
const favoritesGrid = document.getElementById('favoritesGrid');
const searchInput = document.getElementById('searchInput');
const adminBtn = document.getElementById('adminBtn');
const loginModal = document.getElementById('loginModal');
const addMovieModal = document.getElementById('addMovieModal');
const passwordModal = document.getElementById('passwordModal');
const globalPasswordModal = document.getElementById('globalPasswordModal');
const episodeModal = document.getElementById('episodeModal');
const playerContainer = document.getElementById('playerContainer');
const playerIframe = document.getElementById('playerIframe');

let currentMovies = [];
let adminToken = null;
let selectedMovieId = null;
let selectedShow = null;
let authToken = null;
let episodeData = null;

// NEW: Favorites globals
let clientId = localStorage.getItem('clientId');
if (!clientId) {
  clientId = crypto.randomUUID();
  localStorage.setItem('clientId', clientId);
}
let favorites = [];

// NEW: Filter globals
let movies = [];
let tvShows = [];
let currentFilter = 'movies';
const filterTabs = document.querySelectorAll('.filter-tab');

async function getMoviePoster(title, year = '') {
  try {
    const response = await fetch(`https://api.tvmaze.com/search/shows?q=${encodeURIComponent(title)}`);
    const data = await response.json();
    if (data.length > 0 && data[0].show.image && data[0].show.image.medium) {
      return data[0].show.image.medium;
    }
  } catch (err) {}
  try {
    const wikiResponse = await fetch(`https://en.wikipedia.org/api/rest_v1/page/summary/${encodeURIComponent(title.replace(/ /g, '_'))}`);
    const wikiData = await wikiResponse.json();
    if (wikiData.thumbnail && wikiData.thumbnail.source) {
      return wikiData.thumbnail.source;
    }
  } catch (err) {}
  return `https://via.placeholder.com/300x450/333/fff?text=${encodeURIComponent(title.substring(0, 20))}`;
}

function createMovieCard(movie) {
  const card = document.createElement('div');
  card.className = 'movie-card';
  card.innerHTML = `
    <img src="" alt="${movie.title}" loading="lazy">
    <div class="movie-info">
      <h3>${movie.title}</h3>
      <p>${movie.year || ''}</p>
    </div>
    <button class="fav-btn" onclick="toggleFavorite(${movie.id}, this)" style="background: none; border: none; cursor: pointer; font-size: 1.5rem;">${favorites.includes(movie.id) ? '❤️' : '♡'}</button>
  `;
  getMoviePoster(movie.title, movie.year).then(poster => {
    card.querySelector('img').src = poster;
  });
  card.addEventListener('click', () => requestMoviePassword(movie.id, movie.title, movie.type));
  return card;
}

function displayMovies(movies, grid) {
  grid.innerHTML = '';
  movies.forEach(movie => grid.appendChild(createMovieCard(movie)));
}

function filterMovies(term) {
  const filtered = (currentFilter === 'movies' ? movies : currentFilter === 'tv' ? tvShows : favorites.map(id => currentMovies.find(m => m.id === id))).filter(movie => movie.title.toLowerCase().includes(term.toLowerCase()));
  displayMovies(filtered, currentFilter === 'movies' ? movieGrid : currentFilter === 'tv' ? tvGrid : favoritesGrid);
}

// NEW: Toggle favorite
async function toggleFavorite(id, btn) {
  if (favorites.includes(id)) {
    favorites = favorites.filter(f => f !== id);
    btn.innerHTML = '♡';
    await fetch(API + '/favorites', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ movieId: id, clientId })
    });
  } else {
    favorites.push(id);
    btn.innerHTML = '❤️';
    await fetch(API + '/favorites', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ movieId: id, clientId })
    });
  }
  if (currentFilter === 'favorites') filterMovies(searchInput.value);
}

// NEW: Load favorites
async function loadFavorites() {
  const res = await fetch(API + '/favorites/' + clientId);
  const data = await res.json();
  if (data.ok) favorites = data.movies.map(m => m.id);
}

// NEW: Switch filter
function switchFilter(filter) {
  currentFilter = filter;
  document.querySelectorAll('.filter-tab').forEach(t => t.classList.remove('active'));
  document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
  document.querySelectorAll('.section').forEach(s => s.style.display = 'none');
  document.getElementById(filter === 'movies' ? 'movieSection' : filter === 'tv' ? 'tvSection' : 'favoritesSection').style.display = 'block';
  filterMovies(searchInput.value);
}

async function loadMovies() {
  movieGrid.innerHTML = '<p style="text-align:center;color:#aaa;">Loading...</p>';
  try {
    const res = await fetch(API + '/movies');
    const data = await res.json();
    if (!data.ok || !data.movies.length) {
      movieGrid.innerHTML = '<p style="text-align:center;color:#aaa;">No movies found.</p>';
      return;
    }
    currentMovies = data.movies;
    movies = currentMovies.filter(m => m.type === 'movie');
    tvShows = currentMovies.filter(m => m.type === 'tv_show');
    await loadFavorites();
    filterMovies('');
  } catch (err) {
    console.error(err);
    alert('Error loading movies');
  }
}

function openAdminPanel() {
  loginModal.classList.add('active');
}

function closeLoginModal() {
  loginModal.classList.remove('active');
}

async function adminLogin() {
  const password = document.getElementById('adminPassword').value;
  try {
    const res = await fetch(API + '/admin/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    });
    const data = await res.json();
    if (data.ok) {
      adminToken = data.token;
      closeLoginModal();
      adminPanel.classList.add('active');
      loadAdminMovies();
      loadGlobalPasswords();
    } else {
      alert('Wrong password');
    }
  } catch (err) {
    console.error(err);
    alert('Login failed');
  }
}

function closeAddMovieModal() {
  addMovieModal.classList.remove('active');
}

async function addMovie() {
  const title = document.getElementById('movieTitle').value;
  const imdbId = document.getElementById('movieImdbId').value;
  const type = document.getElementById('contentType').value;
  const passwords = document.getElementById('moviePassword').value.split(',').map(p => p.trim()).filter(p => p);
  const oneTimePasswords = document.getElementById('oneTimePassword').value.split(',').map(p => p.trim()).filter(p => p);
  const subtitlesEnabled = document.getElementById('subtitlesEnabled').checked;

  try {
    const res = await fetch(API + '/movies', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${adminToken}`
      },
      body: JSON.stringify({ name: title, imdbId, contentPasswords: passwords, oneTimePasswords, type, subtitlesEnabled })
    });
    const data = await res.json();
    if (data.ok) {
      closeAddMovieModal();
      loadAdminMovies();
      loadMovies();
    } else {
      alert('Failed to add: ' + data.error);
    }
  } catch (err) {
    console.error(err);
    alert('Add failed');
  }
}

function closePasswordModal() {
  passwordModal.classList.remove('active');
}

function closeGlobalPasswordModal() {
  globalPasswordModal.classList.remove('active');
}

function closeEpisodeModal() {
  episodeModal.classList.remove('active');
}

async function loadAdminMovies() {
  const movieList = document.getElementById('movieListAdmin');
  movieList.innerHTML = '';
  try {
    const res = await fetch(API + '/movies');
    const data = await res.json();
    if (data.ok) {
      data.movies.forEach(movie => {
        const item = document.createElement('div');
        item.className = 'movie-item-admin';
        item.innerHTML = `
          <div>${movie.title} (${movie.type}) - Subtitles: ${movie.subtitles_enabled ? 'On' : 'Off'}</div>
          <div>
            <button onclick="toggleSubtitles(${movie.id}, ${!movie.subtitles_enabled})">${movie.subtitles_enabled ? 'Disable' : 'Enable'} Subtitles</button>
            <button onclick="deleteMovie(${movie.id})">Delete</button>
          </div>
        `;
        movieList.appendChild(item);
      });
    }
  } catch (err) {
    console.error('Failed to load admin movies:', err);
  }
}

async function toggleSubtitles(id, enable) {
  try {
    const res = await fetch(API + '/movies/' + id + '/subtitles', {
      method: 'PATCH',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${adminToken}`
      },
      body: JSON.stringify({ subtitlesEnabled: enable })
    });
    const data = await res.json();
    if (data.ok) {
      loadAdminMovies();
      loadMovies();
    } else {
      alert('Failed: ' + data.error);
    }
  } catch (err) {
    alert('Error');
  }
}

async function deleteMovie(id) {
  if (!confirm('Are you sure?')) return;
  try {
    const res = await fetch(API + '/movies/' + id, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${adminToken}` }
    });
    const data = await res.json();
    if (data.ok) {
      loadAdminMovies();
      loadMovies();
    } else alert('Error: ' + data.error);
  } catch (err) {
    console.error(err);
    alert('Delete failed');
  }
}

async function loadGlobalPasswords() {
  try {
    const res = await fetch(API + '/admin/global-passwords', {
      headers: { Authorization: `Bearer ${adminToken}` }
    });
    const data = await res.json();
    if (data.ok) {
      const globalPasswordList = document.getElementById('globalPasswordList');
      globalPasswordList.innerHTML = '';
      if (data.passwords.length === 0) {
        globalPasswordList.innerHTML = '<p>No global passwords</p>';
      } else {
        data.passwords.forEach(pwd => {
          const item = document.createElement('div');
          item.className = 'movie-item-admin';
          item.innerHTML = `
            <div>${pwd.is_one_time ? 'One-Time' : 'Regular'} Password</div>
            <button onclick="deleteGlobalPassword(${pwd.id})">Delete</button>`;
          globalPasswordList.appendChild(item);
        });
      }
    }
  } catch (err) {
    console.error('Failed to load global passwords:', err);
  }
}

async function deleteGlobalPassword(id) {
  if (!confirm('Delete this global password?')) return;
  try {
    const res = await fetch(API + '/admin/global-passwords/' + id, {
      method: 'DELETE',
      headers: { Authorization: `Bearer ${adminToken}` }
    });
    const data = await res.json();
    if (data.ok) loadGlobalPasswords();
    else alert('Error: ' + data.error);
  } catch (err) {
    console.error(err);
    alert('Failed to delete global password');
  }
}

function requestMoviePassword(movieId, title, type) {
  selectedMovieId = movieId;
  selectedShow = { id: movieId, title, type };
  document.getElementById('passwordMovieTitle').textContent = title;
  passwordModal.classList.add('active');
}

async function verifyMoviePassword() {
  const password = document.getElementById('moviePasswordInput').value;
  if (!password) return alert('Please enter password');
  try {
    const res = await fetch(API + '/movies/' + selectedMovieId + '/authorize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    });
    const data = await res.json();
    if (data.ok) {
      authToken = data.token;
      if (selectedShow.type === 'movie') {
        const embedRes = await fetch(API + '/movies/' + selectedMovieId + '/embed', {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const embedData = await embedRes.json();
        if (embedData.ok) {
          showPlayer(embedData.url);
        } else {
          alert('Error: ' + embedData.error);
        }
      } else {
        await requestEpisodeSelection();
      }
    } else {
      alert('Wrong password');
    }
  } catch (err) {
    console.error(err);
    alert('Verification failed');
  }
}

async function requestEpisodeSelection() {
  try {
    const res = await fetch(API + '/movies/' + selectedMovieId + '/episodes');
    const data = await res.json();
    if (data.ok) {
      episodeData = data.seasons;
      const seasonSelect = document.getElementById('seasonSelect');
      seasonSelect.innerHTML = '';
      Object.keys(episodeData).forEach(season => {
        const option = document.createElement('option');
        option.value = season;
        option.textContent = `Season ${season}`;
        seasonSelect.appendChild(option);
      });
      updateEpisodeSelect();
      episodeModal.classList.add('active');
    } else {
      alert('Error: ' + data.error);
    }
  } catch (err) {
    console.error(err);
    alert('Failed to load episodes');
  }
}

function updateEpisodeSelect() {
  const season = document.getElementById('seasonSelect').value;
  const episodeSelect = document.getElementById('episodeSelect');
  episodeSelect.innerHTML = '';
  if (episodeData && episodeData[season]) {
    episodeData[season].forEach(ep => {
      const option = document.createElement('option');
      option.value = ep.episode;
      option.textContent = `${ep.name} (E${ep.episode})`;
      episodeSelect.appendChild(option);
    });
  }
}

async function playSelectedEpisode() {
  const season = document.getElementById('seasonSelect').value;
  const episode = document.getElementById('episodeSelect').value;
  try {
    if (authToken) {
      const embedRes = await fetch(API + '/movies/' + selectedMovieId + '/embed', {
        headers: { Authorization: `Bearer ${authToken}` }
      });
      const embedData = await embedRes.json();
      if (embedData.ok) {
        const url = `${embedData.url}/${season}/${episode}`;
        showPlayer(url);
        episodeModal.classList.remove('active');
      } else {
        alert('Error: ' + embedData.error);
      }
    } else {
      alert('Authorization token missing, please try again.');
    }
  } catch (err) {
    console.error(err);
    alert('Failed to play episode');
  }
}

function showPlayer(url) {
  playerIframe.src = url;
  playerContainer.classList.add('active');
  passwordModal.classList.remove('active');
  document.getElementById('moviePasswordInput').value = '';
}

function closePlayer() {
  playerContainer.classList.remove('active');
  playerIframe.src = '';
  episodeData = null;
  selectedShow = null;
  authToken = null;
}

adminBtn.addEventListener('click', openAdminPanel);
searchInput.addEventListener('input', e => filterMovies(e.target.value));
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closePlayer();
    closeLoginModal();
    closeAddMovieModal();
    closePasswordModal();
    closeGlobalPasswordModal();
    closeEpisodeModal();
  }
});

// NEW: Filter tab listeners
document.querySelectorAll('.filter-tab').forEach(tab => {
  tab.addEventListener('click', () => switchFilter(tab.dataset.filter));
});

loadMovies();
</script>
</body>
</html>
