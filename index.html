<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ogmovie</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#000;color:#fff;font-family:Arial,sans-serif}
  header{text-align:center;padding:2rem;position:relative}
  h1{color:#e50914;font-size:2.5rem}
  #adminBtn{position:absolute;top:2rem;right:2rem;background:#e50914;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;font-weight:bold}
  #searchContainer{max-width:500px;margin:0 auto 1rem auto;padding:0 2rem}
  #searchInput{width:100%;padding:1rem;border-radius:8px;border:2px solid #333;background:#1a1a1a;color:#fff;font-size:1.1rem}
  #searchInput:focus{outline:none;border-color:#e50914}
  #filterTabs{text-align:center;margin:1rem 0;}
  #filterTabs button{margin:0 .25rem;padding:.5rem 1rem;background:#1a1a1a;border:none;color:#fff;border-radius:4px;cursor:pointer}
  #filterTabs button.active{background:#e50914}
  #movieGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1.5rem;padding:2rem;max-width:1400px;margin:0 auto}
  .movie-card{cursor:pointer;border-radius:12px;overflow:hidden;background:#1a1a1a;transition:.3s;position:relative}
  .movie-card:hover{transform:scale(1.05);box-shadow:0 0 20px rgba(229,9,20,.5)}
  .movie-card img{width:100%;height:300px;object-fit:cover}
  .movie-info{padding:1rem;text-align:center;position:relative}
  .movie-info h3{font-size:1.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .movie-info p{color:#aaa;font-size:.9rem}
  .card-actions{position:absolute;bottom:8px;right:8px;display:flex;gap:4px;opacity:0;transition:opacity .2s}
  .movie-card:hover .card-actions{opacity:1}
  .card-actions button{background:rgba(0,0,0,.6);border:none;color:#fff;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:.9rem}
  .card-actions button:hover{background:#e50914}
  .favorite-btn.filled{color:#e50914}
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#1a1a1a;padding:2rem;border-radius:12px;width:90%;max-width:400px;position:relative}
  .close-modal{position:absolute;top:10px;right:15px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer}
  .modal h2{margin-bottom:1.5rem;color:#e50914}
  .form-group{margin-bottom:1rem}
  .form-group label{display:block;margin-bottom:0.5rem;color:#ccc}
  .form-group input{width:100%;padding:0.75rem;border-radius:4px;border:1px solid #333;background:#333;color:#fff}
  .form-group select{width:100%;padding:0.75rem;border-radius:4px;border:1px solid #333;background:#333;color:#fff}
  .modal-btn{width:100%;padding:0.75rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;margin-top:1rem}
  #adminPanel{display:none;padding:2rem;max-width:1400px;margin:0 auto}
  #adminPanel.active{display:block}
  .admin-actions{margin-bottom:2rem;display:flex;gap:1rem;flex-wrap:wrap}
  .admin-btn{padding:0.75rem 1.5rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold}
  .movie-list-admin{margin-top:2rem}
  .movie-item-admin{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#1a1a1a;margin-bottom:1rem;border-radius:8px}
  .movie-item-admin button{background:#ff4444;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer}
  .movie-item-admin button + button{margin-left:0.5rem}
  .player-container{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:999}
  .player-container.active{display:block}
  .close-btn{position:absolute;top:10px;right:10px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;z-index:1001}
  .player-wrapper{position:relative;width:100%;height:100%}
  #playerIframe{width:100%;height:100%;border:none}
  .iframe-overlay{position:absolute;top:5px;left:0;width:160px;height:55px;background:#000;z-index:3;display:flex;align-items:center;justify-content:center;font-weight:bold;color:rgba(255,255,255,.5);letter-spacing:2px;text-transform:uppercase;border-radius:8px;}
  .bottom-left-overlay{position:absolute;bottom:10px;left:200px;width:120px;height:40px;background:#000;z-index:10;border-radius:8px;}
  #requestSection{display:none;padding:2rem;max-width:1400px;margin:0 auto}
  #requestInput{width:100%;max-width:500px;padding:1rem;border-radius:8px;border:2px solid #333;background:#1a1a1a;color:#fff;font-size:1.1rem;margin-bottom:1rem}
  #requestInput:focus{outline:none;border-color:#e50914}
  #requestResults{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1.5rem}
</style>
</head>
<body>
<header>
  <h1>ogmovie</h1>
  <button id="adminBtn">Admin</button>
</header>
<main>
  <div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Search for movies or TV shows..." />
  </div>
  <div id="filterTabs">
    <button class="filter-btn active" data-type="all">All</button>
    <button class="filter-btn" data-type="movie">Movies</button>
    <button class="filter-btn" data-type="tv_show">TV Shows</button>
    <button class="filter-btn" data-type="favorites">Favorites</button>
    <button class="filter-btn" data-type="request">Request</button>
  </div>
  <div id="movieGrid"></div>
  <div id="requestSection">
    <h2>Request New Content</h2>
    <input type="text" id="requestInput" placeholder="Search for movie or TV show to request...">
    <div id="requestResults"></div>
  </div>
  <div id="adminPanel" class="admin-panel"></div>
</main>

<!-- Modals -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeLoginModal()">X</button>
    <h2>Admin Login</h2>
    <div class="form-group">
      <label for="loginType">Login Type:</label>
      <select id="loginType">
        <option value="password">Password</option>
        <option value="code">One-time Code</option>
      </select>
    </div>
    <div class="form-group">
      <label for="adminPassword">Password/Code:</label>
      <input type="password" id="adminPassword" placeholder="Enter admin password or code">
    </div>
    <button class="modal-btn" onclick="adminLogin()">Login</button>
  </div>
</div>

<div id="addMovieModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeAddMovieModal()">X</button>
    <h2>Add Content</h2>
    <div class="form-group">
      <label for="movieTitle">Title:</label>
      <input type="text" id="movieTitle" placeholder="Enter movie or TV show title">
    </div>
    <div class="form-group">
      <label for="movieImdbId">ID (optional):</label>
      <input type="text" id="movieImdbId" placeholder="1234567">
    </div>
    <div class="form-group">
      <label for="contentType">Type:</label>
      <select id="contentType">
        <option value="movie">Movie</option>
        <option value="tv_show">TV Show</option>
      </select>
    </div>
    <div class="form-group">
      <label for="moviePassword">Passwords (comma-separated):</label>
      <input type="text" id="moviePassword" placeholder="pass1,pass2,...">
    </div>
    <div class="form-group">
      <label for="oneTimePassword">One-Time Passwords (comma-separated, optional):</label>
      <input type="text" id="oneTimePassword" placeholder="otp1,otp2,...">
    </div>
    <button class="modal-btn" onclick="addMovie()">Add Content</button>
  </div>
</div>

<div id="passwordModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closePasswordModal()">X</button>
    <h2>Enter Password</h2>
    <p id="passwordMovieTitle" style="margin-bottom:1rem;color:#ccc"></p>
    <div class="form-group">
      <label for="moviePasswordInput">Password:</label>
      <input type="password" id="moviePasswordInput" placeholder="Enter password">
    </div>
    <button class="modal-btn" onclick="verifyMoviePassword()">Watch</button>
  </div>
</div>

<div id="globalPasswordModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeGlobalPasswordModal()">X</button>
    <h2>Add Global Password</h2>
    <div class="form-group">
      <label for="globalPassword">Password:</label>
      <input type="password" id="globalPassword" placeholder="Enter global password">
    </div>
    <div class="form-group">
      <label><input type="checkbox" id="isOneTime"> One-Time Password</label>
    </div>
    <button class="modal-btn" onclick="addGlobalPassword()">Add Global Password</button>
  </div>
</div>

<div id="episodeModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeEpisodeModal()">X</button>
    <h2>Select Episode</h2>
    <p id="episodeShowTitle" style="margin-bottom:1rem;color:#ccc"></p>
    <div class="form-group">
      <label for="seasonSelect">Season:</label>
      <select id="seasonSelect" onchange="updateEpisodeSelect()"></select>
    </div>
    <div class="form-group">
      <label for="episodeSelect">Episode:</label>
      <select id="episodeSelect"></select>
    </div>
    <button class="modal-btn" onclick="playSelectedEpisode()">Watch Episode</button>
  </div>
</div>

<div id="trailerModal" class="modal">
  <div class="modal-content" style="max-width:800px;">
    <button class="close-modal" onclick="closeTrailerModal()">X</button>
    <h2>Trailer</h2>
    <div style="position:relative;padding-bottom:56.25%;height:0;">
      <iframe id="trailerIframe" style="position:absolute;top:0;left:0;width:100%;height:100%;" 
              src="" frameborder="0" allowfullscreen></iframe>
    </div>
  </div>
</div>

<div id="playerContainer" class="player-container">
  <button class="close-btn" onclick="closePlayer()">X</button>
  <div class="player-wrapper">
    <iframe id="playerIframe" allowfullscreen allow="autoplay; fullscreen" referrerpolicy="no-referrer"></iframe>
    <div class="iframe-overlay">ogmovie</div>
    <div class="bottom-left-overlay"></div>
  </div>
</div>

<script>
const API = window.location.origin + '/api';
const movieGrid = document.getElementById('movieGrid');
const requestSection = document.getElementById('requestSection');
const requestInput = document.getElementById('requestInput');
const requestResults = document.getElementById('requestResults');
const playerIframe = document.getElementById('playerIframe');
const playerContainer = document.getElementById('playerContainer');
const adminBtn = document.getElementById('adminBtn');
const adminPanel = document.getElementById('adminPanel');
const loginModal = document.getElementById('loginModal');
const addMovieModal = document.getElementById('addMovieModal');
const passwordModal = document.getElementById('passwordModal');
const globalPasswordModal = document.getElementById('globalPasswordModal');
const episodeModal = document.getElementById('episodeModal');
const trailerModal = document.getElementById('trailerModal');
const searchInput = document.getElementById('searchInput');
let adminToken = null;
let adminRole = null;
let currentMovies = [];
let selectedMovieId = null;
let selectedShow = null;
let episodeData = null;
let authToken = null;
let currentFilter = 'all';
const FAV_KEY = 'ogmovie_favorites';

function debounce(func, delay = 600) {
  let timeout;
  return (...args) => {
    clearTimeout(timeout);
    timeout = setTimeout(() => func(...args), delay);
  };
}

// ——— POSTERS: DB → TV-Maze → Placeholder ———
async function getMoviePoster(title, year = '') {
  try {
    const res = await fetch(`https://api.tvmaze.com/search/shows?q=${encodeURIComponent(title)}`);
    const data = await res.json();
    if (data[0]?.show?.image?.medium) return data[0].show.image.medium;
  } catch {}
  return `https://via.placeholder.com/300x450/1a1a1a/ffffff?text=${encodeURIComponent(title.substring(0,15))}`;
}

function createMovieCard(movie) {
  const year = movie.year || 'N/A';
  const imgSrc = movie.image && !movie.image.includes('placeholder.com')
    ? movie.image
    : `https://via.placeholder.com/300x450/1a1a1a/ffffff?text=${encodeURIComponent(movie.title.substring(0,15))}`;

  const card = document.createElement('div');
  card.className = 'movie-card';
  card.innerHTML = `
    <img src="${imgSrc}" 
         onerror="this.src='https://via.placeholder.com/300x450/1a1a1a/ffffff?text=No+Poster'">
    <div class="movie-info">
      <h3>${movie.title}</h3>
      <p>${year} (${movie.type === 'movie' ? 'Movie' : 'TV Show'})</p>
    </div>
    <div class="card-actions">
      <button class="favorite-btn" data-id="${movie.id}">Heart</button>
      <button class="trailer-btn" data-id="${movie.id}" ${movie.type === 'tv_show' ? 'disabled' : ''}>Trailer</button>
      <button class="play-btn" data-id="${movie.id}">Play</button>
    </div>`;
  card.querySelector('.movie-info').style.cursor = 'pointer';
  card.querySelector('.movie-info').onclick = () => requestMoviePassword(movie.id, movie.title, movie.type);
  return card;
}

// ——— REQUEST TAB: IMDb + Fallback ———
requestInput.addEventListener('input', debounce(async () => {
  const q = requestInput.value.trim();
  if (q.length < 3) {
    requestResults.innerHTML = '';
    return;
  }

  let data;
  try {
    const res = await fetch(`https://v2.sg.media-imdb.com/suggestion/${encodeURIComponent(q)}/1.json`);
    data = await res.json();
  } catch {
    try {
      const res = await fetch(`https://api.tvmaze.com/search/shows?q=${encodeURIComponent(q)}`);
      const tv = await res.json();
      data = { d: tv.map(s => ({
        l: s.show.name,
        y: s.show.premiered ? new Date(s.show.premiered).getFullYear() : null,
        id: s.show.externals?.imdb,
        q: s.show.type === 'Scripted' ? 'tvSeries' : 'movie',
        i: { imageUrl: s.show.image?.medium }
      })) };
    } catch {
      requestResults.innerHTML = '<p style="text-align:center;color:#aaa;">Search failed</p>';
      return;
    }
  }

  requestResults.innerHTML = '';
  const existing = new Set(currentMovies.map(m => m.imdb_id).filter(Boolean));

  (data.d || []).forEach(item => {
    if (!['movie', 'tvSeries', 'tvMiniSeries'].includes(item.q)) return;
    const title = item.l;
    const year = item.y || 'N/A';
    const imdbId = item.id || '';
    const type = item.q === 'movie' ? 'movie' : 'tv_show';
    const imgUrl = item.i?.imageUrl || `https://via.placeholder.com/300x450/1a1a1a/ffffff?text=${encodeURIComponent(title.substring(0,12))}`;
    if (existing.has(imdbId)) return;

    const card = document.createElement('div');
    card.className = 'movie-card';
    card.innerHTML = `
      <img src="${imgUrl}" onerror="this.src='https://via.placeholder.com/300x450/1a1a1a/ffffff?text=No+Poster'">
      <div class="movie-info">
        <h3>${title}</h3>
        <p>${year} (${type === 'movie' ? 'Movie' : 'TV Show'})</p>
      </div>
      <div class="card-actions">
        <button class="trailer-btn" data-title="${title}" ${type === 'tv_show' ? 'disabled' : ''}>Trailer</button>
        <button class="wishlist-btn" data-title="${title}" data-type="${type}" data-imdb="${imdbId}">Wishlist</button>
      </div>`;
    requestResults.appendChild(card);
  });

  if (!(data.d || []).length) {
    requestResults.innerHTML = '<p style="text-align:center;color:#aaa;">No results found</p>';
  }
}));

// ——— ADD MOVIE: Auto-add "tt" + label says "ID" ———
async function addMovie() {
  let imdbId = document.getElementById('movieImdbId').value.trim();
  if (imdbId && /^\d+$/.test(imdbId)) {
    imdbId = 'tt' + imdbId.replace(/^0+/, '');
  }
  const title = document.getElementById('movieTitle').value;
  const type = document.getElementById('contentType').value;
  const passwords = document.getElementById('moviePassword').value.split(',').map(p => p.trim()).filter(p => p);
  const oneTimePasswords = document.getElementById('oneTimePassword').value.split(',').map(p => p.trim()).filter(p => p);
  if (!title && !imdbId) return alert('Please provide title or ID');

  try {
    const res = await fetch(API + '/movies', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        Authorization: `Bearer ${adminToken}`
      },
      body: JSON.stringify({ name: title, imdbId, contentPasswords: passwords, oneTimePasswords, type })
    });
    const data = await res.json();
    if (data.ok) {
      alert('Content added successfully');
      closeAddMovieModal();
      if (adminRole === 'limited_admin') {
        alert('Your one-time access is now expired.');
        exitAdmin();
      } else {
        loadAdminMovies();
      }
      loadMovies();
    } else alert('Error: ' + data.error);
  } catch (err) {
    console.error(err);
    alert('Failed to add content');
  }
}

// ——— REST OF YOUR ORIGINAL CODE (unchanged) ———
function displayMovies(movies) {
  movieGrid.innerHTML = '';
  if (movies.length === 0) {
    movieGrid.innerHTML = '<p style="text-align:center;color:#aaa;grid-column:1/-1;">No movies found</p>';
    return;
  }
  movies.forEach(movie => movieGrid.appendChild(createMovieCard(movie)));
  updateFavoriteButtons();
}

function updateFavoriteButtons() {
  const favs = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
  document.querySelectorAll('.favorite-btn').forEach(btn => {
    const id = parseInt(btn.dataset.id);
    btn.textContent = favs.includes(id) ? 'Heart' : 'Heart';
  });
}

function applyFilters(search = '') {
  if (currentFilter === 'request') {
    movieGrid.style.display = 'none';
    document.getElementById('searchContainer').style.display = 'none';
    requestSection.style.display = 'block';
    return;
  }
  movieGrid.style.display = 'grid';
  document.getElementById('searchContainer').style.display = 'block';
  requestSection.style.display = 'none';
  let list = currentMovies;
  const lower = search.toLowerCase();
  if (search) list = list.filter(m => m.title.toLowerCase().includes(lower));
  if (currentFilter === 'movie') list = list.filter(m => m.type === 'movie');
  if (currentFilter === 'tv_show') list = list.filter(m => m.type === 'tv_show');
  if (currentFilter === 'favorites') {
    const favIds = new Set(JSON.parse(localStorage.getItem(FAV_KEY) || '[]'));
    list = list.filter(m => favIds.has(m.id));
  }
  displayMovies(list);
}

document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    currentFilter = btn.dataset.type;
    applyFilters(searchInput.value);
  });
});

document.addEventListener('click', async e => {
  const btn = e.target;
  if (btn.classList.contains('favorite-btn')) {
    const id = parseInt(btn.dataset.id);
    let favs = JSON.parse(localStorage.getItem(FAV_KEY) || '[]');
    const idx = favs.indexOf(id);
    if (idx > -1) favs.splice(idx, 1);
    else favs.push(id);
    localStorage.setItem(FAV_KEY, JSON.stringify(favs));
    updateFavoriteButtons();
    if (currentFilter === 'favorites') applyFilters(searchInput.value);
    return;
  }
  if (btn.classList.contains('play-btn')) {
    const id = parseInt(btn.dataset.id);
    const movie = currentMovies.find(m => m.id === id);
    requestMoviePassword(id, movie.title, movie.type);
    return;
  }
  if (btn.classList.contains('trailer-btn')) {
    const id = btn.dataset.id;
    const title = btn.dataset.title;
    let url;
    if (id) url = `${API}/movies/${id}/trailer`;
    else if (title) url = `${API}/trailer?title=${encodeURIComponent(title)}`;
    if (url) {
      try {
        const r = await fetch(url);
        const data = await r.json();
        if (data.ok) {
          document.getElementById('trailerIframe').src = data.url;
          trailerModal.classList.add('active');
        } else {
          alert('Trailer not available: ' + data.error);
        }
      } catch {
        alert('Failed to load trailer');
      }
    }
    return;
  }
  if (btn.classList.contains('wishlist-btn')) {
    const {title, type, imdb} = btn.dataset;
    try {
      const res = await fetch(`${API}/wishlist`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({title, type, imdb_id: imdb})
      });
      const data = await res.json();
      if (data.ok) {
        alert('Requested! Pending review. Check back in 24 hours.');
        btn.disabled = true;
        btn.textContent = 'Requested';
      } else {
        alert(data.error || 'Already available');
      }
    } catch {
      alert('Failed to request');
    }
    return;
  }
});

function closeTrailerModal() {
  trailerModal.classList.remove('active');
  document.getElementById('trailerIframe').src = '';
}

searchInput.addEventListener('input', e => applyFilters(e.target.value));

// ——— LOAD MOVIES: Use DB image first ———
async function loadMovies() {
  movieGrid.innerHTML = '<p style="text-align:center;color:#aaa;">Loading...</p>';
  try {
    const res = await fetch(API + '/movies');
    const data = await res.json();
    if (!data.ok || !data.movies.length) {
      movieGrid.innerHTML = '<p style="text-align:center;color:#aaa;">No movies found.</p>';
      return;
    }
    currentMovies = [];
    for (const movie of data.movies) {
      let img = movie.image;
      if (!img || img.includes('placeholder.com')) {
        const poster = await getMoviePoster(movie.title, movie.year);
        if (poster && !poster.includes('placeholder.com')) img = poster;
      }
      movie.image = img || `https://via.placeholder.com/300x450/1a1a1a/ffffff?text=${encodeURIComponent(movie.title.substring(0,15))}`;
      currentMovies.push(movie);
    }
    applyFilters();
  } catch (err) {
    console.error(err);
    movieGrid.innerHTML = '<p style="text-align:center;color:#aaa;">Error loading movies</p>';
  }
}

adminBtn.addEventListener('click', openAdminPanel);
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closePlayer(); closeLoginModal(); closeAddMovieModal(); closePasswordModal();
    closeGlobalPasswordModal(); closeEpisodeModal(); closeTrailerModal();
  }
});

loadMovies();
</script>
</body>
</html>
