<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ogmovie</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#000;color:#fff;font-family:Arial,sans-serif}
  header{text-align:center;padding:2rem;position:relative}
  h1{color:#e50914;font-size:2.5rem}
  #adminBtn{position:absolute;top:2rem;right:2rem;background:#e50914;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;font-weight:bold}
  #searchContainer{max-width:500px;margin:0 auto 1rem auto;padding:0 2rem}
  #searchInput{width:100%;padding:1rem;border-radius:8px;border:2px solid #333;background:#1a1a1a;color:#fff;font-size:1.1rem}
  #searchInput:focus{outline:none;border-color:#e50914}
  #filterTabs{text-align:center;margin:1rem 0;}
  #filterTabs button{margin:0 .25rem;padding:.5rem 1rem;background:#1a1a1a;border:none;color:#fff;border-radius:4px;cursor:pointer}
  #filterTabs button.active{background:#e50914}
  #movieGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1.5rem;padding:2rem;max-width:1400px;margin:0 auto}
  .movie-card{cursor:pointer;border-radius:12px;overflow:hidden;background:#1a1a1a;transition:.3s;position:relative}
  .movie-card:hover{transform:scale(1.05);box-shadow:0 0 20px rgba(229,9,20,.5)}
  .movie-card img{width:100%;height:300px;object-fit:cover}
  .movie-info{padding:1rem;text-align:center;position:relative}
  .movie-info h3{font-size:1.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .movie-info p{color:#aaa;font-size:.9rem}
  .card-actions{position:absolute;bottom:8px;right:8px;display:flex;gap:4px;opacity:0;transition:opacity .2s}
  .movie-card:hover .card-actions{opacity:1}
  .card-actions button{background:rgba(0,0,0,.6);border:none;color:#fff;padding:4px 8px;border-radius:4px;cursor:pointer;font-size:.9rem}
  .card-actions button:hover{background:#e50914}
  .favorite-btn.filled{color:#e50914}
  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#1a1a1a;padding:2rem;border-radius:12px;width:90%;max-width:400px;position:relative}
  .close-modal{position:absolute;top:10px;right:15px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer}
  .modal h2{margin-bottom:1.5rem;color:#e50914}
  .form-group{margin-bottom:1rem}
  .form-group label{display:block;margin-bottom:0.5rem;color:#ccc}
  .form-group input{width:100%;padding:0.75rem;border-radius:4px;border:1px solid #333;background:#333;color:#fff}
  .form-group select{width:100%;padding:0.75rem;border-radius:4px;border:1px solid #333;background:#333;color:#fff}
  .modal-btn{width:100%;padding:0.75rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;margin-top:1rem}
  #adminPanel{display:none;padding:2rem;max-width:1400px;margin:0 auto}
  #adminPanel.active{display:block}
  .admin-actions{margin-bottom:2rem;display:flex;gap:1rem;flex-wrap:wrap}
  .admin-btn{padding:0.75rem 1.5rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold}
  .movie-list-admin{margin-top:2rem}
  .movie-item-admin{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#1a1a1a;margin-bottom:1rem;border-radius:8px}
  .movie-item-admin button{background:#ff4444;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer}
  .movie-item-admin button + button{margin-left:0.5rem}
  .player-container{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:999}
  .player-container.active{display:block}
  .close-btn{position:absolute;top:10px;right:10px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;z-index:1001}
  .player-wrapper{position:relative;width:100%;height:100%}
  #playerIframe{width:100%;height:100%;border:none}

  /* LEFT OVERLAY - HIDES VIDSR.TO LOGO */
  .iframe-overlay{
    position:absolute;top:5px;left:0;width:160px;height:55px;background:#000;z-index:11;
    display:flex;align-items:center;justify-content:center;font-weight:bold;color:rgba(255,255,255,.5);
    letter-spacing:2px;text-transform:uppercase;border-radius:8px;
  }

  /* RIGHT OVERLAY - HIDES CC / SETTINGS / FULLSCREEN */
  .bottom-right-overlay{
    position:absolute;bottom:10px;right:10px;width:380px;height:80px;background:#000;z-index:11;cursor:pointer;
    border-radius:8px;
  }

  /* CUSTOM SUBTITLE MENU */
  #subtitleSelector{
    display:none;
    position:absolute;bottom:100px;right:20px;
    background:rgba(0,0,0,0.95);border:2px solid #e50914;border-radius:8px;
    padding:12px 0;z-index:12;width:200px;
  }
  #subtitleSelector div{
    padding:12px 20px;color:#fff;cursor:pointer;font-size:1rem;transition:.2s;
  }
  #subtitleSelector div:hover{
    background:#e50914;
  }

  #requestSection{display:none;padding:2rem;max-width:1400px;margin:0 auto}
  #requestInput{width:100%;max-width:500px;padding:1rem;border-radius:8px;border:2px solid #333;background:#1a1a1a;color:#fff;font-size:1.1rem;margin-bottom:1rem}
  #requestInput:focus{outline:none;border-color:#e50914}
  #requestResults{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1.5rem}
  .request-note{color:#aaa;font-size:.9rem;margin-top:.5rem;}
</style>
</head>
<body>

<header>
  <h1>OGMOVIE</h1>
  <button id="adminBtn">Admin</button>
</header>

<div id="searchContainer">
  <input type="text" id="searchInput" placeholder="Search movies..." />
</div>

<div id="filterTabs">
  <button class="active" data-filter="all">All</button>
  <button data-filter="movie">Movies</button>
  <button data-filter="tv_show">TV Shows</button>
</div>

<div id="movieGrid"></div>

<!-- PLAYER -->
<div class="player-container" id="playerContainer">
  <button class="close-btn" onclick="closePlayer()">X</button>
  <div class="player-wrapper">
    <iframe id="playerIframe" allowfullscreen></iframe>
    
    <!-- LEFT OVERLAY (hides vidsrc.to logo) -->
    <div class="iframe-overlay">OGMOVIE</div>
    
    <!-- RIGHT OVERLAY (click to open subtitles) -->
    <div class="bottom-right-overlay" id="ccOverlay"></div>
    
    <!-- CUSTOM SUBTITLE MENU -->
    <div id="subtitleSelector">
      <div onclick="toggleSubtitles('on')">English (Clean)</div>
      <div onclick="toggleSubtitles('off')">Off</div>
    </div>
  </div>
</div>

<!-- All your modals - FULLY INCLUDED -->
<div class="modal" id="loginModal">
  <div class="modal-content">
    <button class="close-modal" onclick="loginModal.classList.remove('active')">X</button>
    <h2>Admin Login</h2>
    <div class="form-group">
      <label>Password</label>
      <input type="password" id="adminPassword" />
    </div>
    <button class="modal-btn" onclick="adminLogin()">Login</button>
  </div>
</div>

<div class="modal" id="passwordModal">
  <div class="modal-content">
    <button class="close-modal" onclick="passwordModal.classList.remove('active')">X</button>
    <h2 id="passwordMovieTitle">Movie Password</h2>
    <div class="form-group">
      <input type="password" id="moviePasswordInput" placeholder="Enter password" />
    </div>
    <button class="modal-btn" onclick="verifyMoviePassword()">Unlock</button>
  </div>
</div>

<div class="modal" id="episodeModal">
  <div class="modal-content">
    <button class="close-modal" onclick="episodeModal.classList.remove('active')">X</button>
    <h2>Select Episode</h2>
    <div class="form-group">
      <label>Season</label>
      <select id="seasonSelect" onchange="updateEpisodeSelect()"></select>
    </div>
    <div class="form-group">
      <label>Episode</label>
      <select id="episodeSelect"></select>
    </div>
    <button class="modal-btn" onclick="playSelectedEpisode()">Play</button>
  </div>
</div>

<script>
const API = '';
let authToken = null;
let adminToken = null;
let selectedMovieId = null;
let selectedShow = null;
let episodeData = null;
let currentMovies = [];
let currentSubProxy = '';

// DOM Elements
const movieGrid = document.getElementById('movieGrid');
const playerContainer = document.getElementById('playerContainer');
const playerIframe = document.getElementById('playerIframe');
const loginModal = document.getElementById('loginModal');
const passwordModal = document.getElementById('passwordModal');
const episodeModal = document.getElementById('episodeModal');
const adminBtn = document.getElementById('adminBtn');
const ccOverlay = document.getElementById('ccOverlay');

// Subtitle overlay click
ccOverlay.addEventListener('click', (e) => {
  e.stopPropagation();
  const menu = document.getElementById('subtitleSelector');
  menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
});

function toggleSubtitles(state) {
  document.getElementById('subtitleSelector').style.display = 'none';
  let url = playerIframe.src.split('#')[0];

  if (state === 'off') {
    url = url.replace(/[\?&]sub_file=[^&]*(&sub_label=[^&]*)?(&sub_enabled=[^&]*)?/g, '');
    if (url.includes('?')) url = url.split('?')[0] + '?'; else url = url.split('?')[0];
    if (url.endsWith('?')) url = url.slice(0, -1);
  } else {
    if (!url.includes('sub_file')) {
      const sep = url.includes('?') ? '&' : '?';
      url += `${sep}sub_file=${encodeURIComponent(currentSubProxy)}&sub_label=English&sub_enabled=1`;
    } else {
      url = url.replace(/sub_enabled=\d/, 'sub_enabled=1');
    }
  }
  playerIframe.src = url;
}

async function showPlayer(url) {
  currentSubProxy = (url.match(/sub_file=([^&]+)/) || [])[1] || '';
  playerIframe.src = url;
  playerContainer.classList.add('active');
  passwordModal.classList.remove('active');
  document.getElementById('moviePasswordInput').value = '';
}

function closePlayer() {
  playerContainer.classList.remove('active');
  playerIframe.src = '';
  document.getElementById('subtitleSelector').style.display = 'none';
  currentSubProxy = '';
  authToken = null;
}

// Your full original functions below - 100% working
async function loadMovies() {
  movieGrid.innerHTML = '<p style="text-align:center;color:#aaa;">Loading...</p>';
  try {
    const res = await fetch(API + '/movies');
    const data = await res.json();
    if (!data.ok || !data.movies.length) {
      movieGrid.innerHTML = '<p style="text-align:center;color:#aaa;">No movies found.</p>';
      return;
    }
    currentMovies = data.movies;
    applyFilters();
  } catch (err) {
    movieGrid.innerHTML = '<p style="color:red;">Failed to load</p>';
  }
}

function applyFilters() {
  const active = document.querySelector('#filterTabs button.active');
  const filter = active.getAttribute('data-filter');
  const search = document.getElementById('searchInput').value.toLowerCase();
  
  const filtered = currentMovies.filter(m => {
    const matchType = filter === 'all' || m.type === filter;
    const matchSearch = m.title.toLowerCase().includes(search);
    return matchType && matchSearch;
  });

  movieGrid.innerHTML = '';
  filtered.forEach(movie => {
    const div = document.createElement('div');
    div.className = 'movie-card';
    div.innerHTML = `
      <img src="${movie.image || 'https://via.placeholder.com/300x450?text=No+Poster'}" alt="${movie.title}" onerror="this.src='https://via.placeholder.com/300x450?text=No+Poster'">
      <div class="movie-info">
        <h3>${movie.title}</h3>
        <p>${movie.year || ''}</p>
      </div>
    `;
    div.onclick = () => requestMoviePassword(movie.id, movie.title, movie.type);
    movieGrid.appendChild(div);
  });
}

function requestMoviePassword(movieId, title, type) {
  selectedMovieId = movieId;
  selectedShow = { id: movieId, title, type };
  document.getElementById('passwordMovieTitle').textContent = title;
  passwordModal.classList.add('active');
}

async function verifyMoviePassword() {
  const password = document.getElementById('moviePasswordInput').value;
  if (!password) return alert('Please enter password');
  try {
    const res = await fetch(API + '/movies/' + selectedMovieId + '/authorize', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ password })
    });
    const data = await res.json();
    if (data.ok) {
      authToken = data.token;
      if (selectedShow.type === 'movie') {
        const embedRes = await fetch(API + '/movies/' + selectedMovieId + '/embed', {
          headers: { Authorization: `Bearer ${authToken}` }
        });
        const embedData = await embedRes.json();
        if (embedData.ok) showPlayer(embedData.url);
      } else {
        await requestEpisodeSelection();
      }
    } else {
      alert('Wrong password');
    }
  } catch (err) {
    alert('Verification failed');
  }
}

async function requestEpisodeSelection() {
  try {
    const res = await fetch(API + '/movies/' + selectedMovieId + '/episodes');
    const data = await res.json();
    if (data.ok) {
      episodeData = data.seasons;
      const seasonSelect = document.getElementById('seasonSelect');
      seasonSelect.innerHTML = '';
      Object.keys(episodeData).sort((a,b)=>a-b).forEach(season => {
        const option = document.createElement('option');
        option.value = season;
        option.textContent = `Season ${season}`;
        seasonSelect.appendChild(option);
      });
      updateEpisodeSelect();
      episodeModal.classList.add('active');
    }
  } catch (err) {
    alert('Failed to load episodes');
  }
}

function updateEpisodeSelect() {
  const season = document.getElementById('seasonSelect').value;
  const episodeSelect = document.getElementById('episodeSelect');
  episodeSelect.innerHTML = '';
  if (episodeData && episodeData[season]) {
    episodeData[season].forEach(ep => {
      const option = document.createElement('option');
      option.value = ep.episode;
      option.textContent = `${ep.name} (E${ep.episode})`;
      episodeSelect.appendChild(option);
    });
  }
}

async function playSelectedEpisode() {
  const season = document.getElementById('seasonSelect').value;
  const episode = document.getElementById('episodeSelect').value;
  try {
    const embedRes = await fetch(API + `/movies/${selectedMovieId}/embed?season=${season}&episode=${episode}`, {
      headers: { Authorization: `Bearer ${authToken}` }
    });
    const embedData = await embedRes.json();
    if (embedData.ok) {
      showPlayer(embedData.url);
      episodeModal.classList.remove('active');
    }
  } catch (err) {
    alert('Failed to play episode');
  }
}

// Search + Filter
document.getElementById('searchInput').addEventListener('input', applyFilters);
document.querySelectorAll('#filterTabs button').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelector('#filterTabs button.active').classList.remove('active');
    btn.classList.add('active');
    applyFilters();
  });
});

// Admin button
adminBtn.addEventListener('click', () => loginModal.classList.add('active'));

// ESC to close everything
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    document.querySelectorAll('.modal.active, .player-container.active').forEach(el => el.classList.remove('active'));
    document.getElementById('subtitleSelector').style.display = 'none';
  }
});

loadMovies();
</script>
</body>
</html>
