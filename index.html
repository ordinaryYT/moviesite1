<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>OGMovie</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{background:#000;color:#fff;font-family:Arial,sans-serif;overflow-x:hidden}
    header{text-align:center;padding:2rem;position:relative}
    h1{color:#e50914;font-size:2.5rem}
    #adminBtn{position:absolute;top:2rem;right:2rem;background:#e50914;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;font-weight:bold}
    #openElectronBtn{position:fixed;bottom:20px;right:20px;z-index:99999;padding:12px 20px;background:#e50914;color:#fff;border:none;border-radius:8px;font-weight:bold;cursor:pointer;}
    #searchContainer{max-width:500px;margin:0 auto 1rem auto;padding:0 2rem}
    #searchInput{width:100%;padding:1rem;border-radius:8px;border:2px solid #333;background:#1a1a1a;color:#fff;font-size:1.1rem}
    #searchInput:focus{outline:none;border-color:#e50914}
    #filterTabs{text-align:center;margin:1rem 0;}
    #filterTabs button{margin:0 .25rem;padding:.5rem 1rem;background:#1a1a1a;border:none;color:#fff;border-radius:4px;cursor:pointer}
    #filterTabs button.active{background:#e50914}
    #movieGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:1.5rem;padding:2rem;max-width:1400px;margin:0 auto}
    .movie-card{cursor:pointer;border-radius:12px;overflow:hidden;background:#1a1a1a;transition:.3s;position:relative}
    .movie-card:hover{transform:scale(1.05);box-shadow:0 0 20px rgba(229,9,20,.5)}
    .movie-card img{width:100%;height:300px;object-fit:cover}
    .movie-info{padding:1rem;text-align:center;position:relative}
    .movie-info h3{font-size:1.1rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .movie-info p{color:#aaa;font-size:.9rem}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.8);z-index:1000;align-items:center;justify-content:center}
    .modal.active{display:flex}
    .modal-content{background:#1a1a1a;padding:2rem;border-radius:12px;width:90%;max-width:400px;position:relative}
    .close-modal{position:absolute;top:10px;right:15px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer}
    .modal h2{margin-bottom:1.5rem;color:#e50914}
    .form-group{margin-bottom:1rem}
    .form-group label{display:block;margin-bottom:0.5rem;color:#ccc}
    .form-group input{width:100%;padding:0.75rem;border-radius:4px;border:1px solid #333;background:#333;color:#fff}
    .modal-btn{width:100%;padding:0.75rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;margin-top:1rem}
    #adminPanel{display:none;padding:2rem;max-width:1400px;margin:0 auto}
    #adminPanel.active{display:block}
    .admin-actions{margin-bottom:2rem;display:flex;gap:1rem;flex-wrap:wrap}
    .admin-btn{padding:0.75rem 1.5rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold}
    .player-container{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:999}
    .player-container.active{display:block}
    .close-btn{position:absolute;top:10px;right:10px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;z-index:1001}
    #playerIframe{width:100%;height:100%;border:none}

    /* Watch Together */
    #togetherSection{display:none;padding:2rem;max-width:1400px;margin:0 auto}
    #togetherSection.active{display:block}
    #roomList{margin-top:1rem}
    .room-item{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#1a1a1a;margin-bottom:1rem;border-radius:8px}
    .room-item button{background:#333;color:#fff;padding:0.5rem 1rem;border:none;border-radius:4px;cursor:pointer}
    .room-item button:hover{background:#e50914}
    .room-status{font-size:0.9rem;color:#0f0}
    .room-private{color:#ff0}
  </style>
</head>
<body>
  <header>
    <h1>OGMovie</h1>
    <button id="adminBtn">Admin</button>
  </header>

  <main>
    <div id="searchContainer">
      <input type="text" id="searchInput" placeholder="Search for movies or TV shows..." />
    </div>
    <div id="filterTabs">
      <button class="filter-btn active" data-type="all">All</button>
      <button class="filter-btn" data-type="movie">Movies</button>
      <button class="filter-btn" data-type="tv_show">TV Shows</button>
      <button class="filter-btn" data-type="favorites">Favorites</button>
      <button class="filter-btn" data-type="request">Request</button>
      <button class="filter-btn" data-type="together">Watch Together</button>
    </div>

    <div id="movieGrid"></div>

    <div id="requestSection">
      <h2>Request New Content</h2>
      <input type="text" id="requestInput" placeholder="Search for movie or TV show to request...">
      <p class="request-note">
        <strong>Note:</strong> Some images may be broken. Watch the trailer to confirm.
      </p>
      <div id="requestResults"></div>
    </div>

    <!-- WATCH TOGETHER -->
    <div id="togetherSection">
      <h2>Watch Together</h2>
      <p>Use <strong>OGMovie Desktop App</strong> to host or join.</p>
      <div id="roomList">
        <p style="text-align:center;color:#aaa;">Loading rooms...</p>
      </div>
    </div>

    <div id="adminPanel" class="admin-panel"></div>
  </main>

  <button id="openElectronBtn">Open Desktop App</button>

  <!-- Player -->
  <div id="playerContainer" class="player-container">
    <button class="close-btn" onclick="closePlayer()">X</button>
    <iframe id="playerIframe" allow="autoplay"></iframe>
  </div>

  <script>
    const API = '';
    let roomRefreshInterval = null;

    // Open Desktop App
    document.getElementById('openElectronBtn').onclick = () => {
      location.href = 'ogmovie://open';
    };

    // Filter Tabs
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.onclick = () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        applyFilters();
      };
    });

    function applyFilters() {
      const type = document.querySelector('.filter-btn.active').dataset.type;
      document.getElementById('movieGrid').style.display = 'none';
      document.getElementById('requestSection').style.display = 'none';
      document.getElementById('togetherSection').style.display = 'none';

      if (['all', 'movie', 'tv_show', 'favorites'].includes(type)) {
        document.getElementById('movieGrid').style.display = 'grid';
        loadMovies();
      } else if (type === 'request') {
        document.getElementById('requestSection').style.display = 'block';
      } else if (type === 'together') {
        document.getElementById('togetherSection').classList.add('active');
        startRoomAutoRefresh();
      }
    }

    // AUTO-REFRESH ROOMS
    function loadWatchTogetherRooms() {
      const list = document.getElementById('roomList');
      fetch(API + '/api/wt-rooms')
        .then(r => r.json())
        .then(data => {
          if (data.ok && data.rooms.length > 0) {
            list.innerHTML = '';
            data.rooms.forEach(room => {
              const div = document.createElement('div');
              div.className = 'room-item';
              div.innerHTML = `
                <div>
                  <strong>${room.title}</strong> (${room.year})
                  <span class="room-status">Live</span>
                  ${room.isPrivate ? '<span class="room-private">Private</span>' : ''}
                </div>
                <button onclick="alert('Open OGMovie Desktop App and enter code: ${room.code}')">Join</button>
              `;
              list.appendChild(div);
            });
          } else {
            list.innerHTML = '<p style="text-align:center;color:#aaa;">No active rooms. Open the desktop app to host!</p>';
          }
        })
        .catch(() => {
          list.innerHTML = '<p style="color:#faa;">Failed to load rooms.</p>';
        });
    }

    function startRoomAutoRefresh() {
      if (roomRefreshInterval) clearInterval(roomRefreshInterval);
      loadWatchTogetherRooms();
      roomRefreshInterval = setInterval(loadWatchTogetherRooms, 5000);
    }

    // Load Movies
    async function loadMovies() {
      const grid = document.getElementById('movieGrid');
      grid.innerHTML = '<p style="text-align:center;color:#aaa;">Loading...</p>';
      try {
        const res = await fetch(API + '/api/movies');
        const data = await res.json();
        if (data.ok && data.movies.length) {
          renderMovies(data.movies);
        } else {
          grid.innerHTML = '<p style="text-align:center;color:#aaa;">No movies found.</p>';
        }
      } catch {
        grid.innerHTML = '<p style="color:red;">Failed to load</p>';
      }
    }

    function renderMovies(movies) {
      const grid = document.getElementById('movieGrid');
      grid.innerHTML = '';
      movies.forEach(movie => {
        const card = document.createElement('div');
        card.className = 'movie-card';
        card.onclick = () => alert('Password required (use desktop app)');
        card.innerHTML = `
          <img src="${movie.image || 'https://via.placeholder.com/300x450/333/fff?text=No+Image'}" alt="${movie.title}">
          <div class="movie-info">
            <h3>${movie.title}</h3>
            <p>${movie.year || 'N/A'} â€¢ ${movie.type === 'movie' ? 'Movie' : 'TV'}</p>
          </div>
        `;
        grid.appendChild(card);
      });
    }

    // Start
    loadMovies();
  </script>
</body>
</html>
