<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>ogmovie</title>
<style>
  *{margin:0;padding:0;box-sizing:border-box}
  body{background:#000;color:#fff;font-family:Arial,sans-serif;overflow-x:hidden}
  header{text-align:center;padding:2rem;position:relative}
  h1{color:#e50914;font-size:2.5rem}
  #adminBtn{position:absolute;top:2rem;right:2rem;background:#e50914;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer;font-weight:bold}

  #searchContainer{max-width:500px;margin:0 auto 1rem;padding:0 2rem}
  #searchInput{width:100%;padding:1rem;border-radius:8px;border:2px solid #333;background:#1a1a1a;color:#fff;font-size:1.1rem}
  #searchInput:focus{outline:none;border-color:#e50914}

  .filter-tabs{display:flex;justify-content:center;gap:1rem;margin:1.5rem 0;flex-wrap:wrap;padding:0 1rem}
  .filter-tab{padding:0.5rem 1.2rem;background:#1a1a1a;border-radius:6px;cursor:pointer;font-weight:bold;transition:.3s}
  .filter-tab.active{background:#e50914}

  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1.2rem;padding:0 1rem;max-width:1400px;margin:0 auto}

  .movie-card{
    border-radius:12px;overflow:hidden;background:#111;
    transition:transform .3s,box-shadow .3s;cursor:pointer;
  }
  .movie-card:hover{transform:scale(1.04);box-shadow:0 0 20px rgba(229,9,20,.4)}

  .movie-card img{width:100%;height:260px;object-fit:cover;background:#000}

  .info{padding:0.7rem 0.8rem}
  .info h3{font-size:0.95rem;line-height:1.3;margin-bottom:0.2rem;
    display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden;color:#fff}
  .info .year{font-size:0.8rem;color:#aaa;margin-bottom:0.6rem}

  .actions{display:flex;gap:0.4rem;justify-content:space-between;align-items:center;padding:0 0.6rem 0.6rem}
  .actions button{
    flex:1;background:#222;color:#fff;border:none;padding:0.45rem 0;
    border-radius:6px;font-size:0.8rem;cursor:pointer;transition:.2s;font-weight:bold;
  }
  .actions button:hover{background:#e50914}
  .actions .fav-btn{
    background:none;font-size:1.4rem;color:#ccc;
  }
  .actions .fav-btn.active{color:#e50914}

  .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.9);z-index:1000;align-items:center;justify-content:center}
  .modal.active{display:flex}
  .modal-content{background:#1a1a1a;padding:2rem;border-radius:12px;width:90%;max-width:400px;position:relative}
  .close-modal{position:absolute;top:10px;right:15px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer}
  .modal h2{margin-bottom:1.5rem;color:#e50914}
  .form-group{margin-bottom:1rem}
  .form-group label{display:block;margin-bottom:0.5rem;color:#ccc}
  .form-group input,.form-group select{width:100%;padding:0.75rem;border-radius:4px;border:1px solid #333;background:#333;color:#fff}
  .modal-btn{width:100%;padding:0.75rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold;margin-top:1rem}

  #adminPanel{display:none;padding:2rem;max-width:1400px;margin:0 auto}
  #adminPanel.active{display:block}
  .admin-actions{margin-bottom:2rem;display:flex;gap:1rem;flex-wrap:wrap}
  .admin-btn{padding:0.75rem 1.5rem;background:#e50914;color:white;border:none;border-radius:4px;cursor:pointer;font-weight:bold}
  .movie-item-admin{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:#1a1a1a;margin-bottom:1rem;border-radius:8px}
  .movie-item-admin button{background:#ff4444;color:white;border:none;padding:0.5rem 1rem;border-radius:4px;cursor:pointer}

  .player-container{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:999}
  .player-container.active{display:block}
  .close-btn{position:absolute;top:10px;right:10px;background:none;border:none;color:#fff;font-size:1.5rem;cursor:pointer;z-index:1001}
  .player-wrapper{position:relative;width:100%;height:100%}
  #playerIframe{width:100%;height:100%;border:none}
  .iframe-overlay{position:absolute;top:5px;left:0;width:160px;height:55px;background:#000;z-index:3;display:flex;align-items:center;justify-content:center;font-weight:bold;color:rgba(255,255,255,.5);letter-spacing:2px;text-transform:uppercase;border-radius:8px}
  .bottom-left-overlay{position:absolute;bottom:10px;left:200px;width:120px;height:40px;background:#000;z-index:10;border-radius:8px}
</style>
</head>
<body>
<header>
  <h1>ogmovie</h1>
  <button id="adminBtn">Admin</button>
</header>
<main>
  <div id="searchContainer">
    <input type="text" id="searchInput" placeholder="Search any movie or TV show..." />
  </div>

  <div class="filter-tabs">
    <div class="filter-tab active" data-filter="all">All</div>
    <div class="filter-tab" data-filter="movie">Movies</div>
    <div class="filter-tab" data-filter="tv_show">TV Shows</div>
    <div class="filter-tab" data-filter="favorites">Favorites</div>
  </div>

  <section id="allSection"><div id="allGrid" class="grid"></div></section>
  <section id="movieSection" style="display:none"><div id="movieGrid" class="grid"></div></section>
  <section id="tvSection" style="display:none"><div id="tvGrid" class="grid"></div></section>
  <section id="favoritesSection" style="display:none"><div id="favoritesGrid" class="grid"></div></section>

  <div id="adminPanel">
    <div class="admin-actions">
      <button class="admin-btn" onclick="openAddMovieModal()">Add Content</button>
      <button class="admin-btn" onclick="openGlobalPasswordModal()">Add Global Password</button>
      <button class="admin-btn" onclick="loadAdminMovies()">Refresh List</button>
    </div>
    <div id="movieListAdmin"></div>
    <div id="globalPasswordList" style="margin-top:2rem"></div>
  </div>
</main>

<!-- Login Modal -->
<div id="loginModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeLoginModal()">x</button>
    <h2>Admin Login</h2>
    <div class="form-group">
      <label for="adminPassword">Password:</label>
      <input type="password" id="adminPassword">
    </div>
    <button class="modal-btn" onclick="adminLogin()">Login</button>
  </div>
</div>

<!-- Add Movie Modal -->
<div id="addMovieModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeAddMovieModal()">x</button>
    <h2>Add Content</h2>
    <div class="form-group"><label>Title:</label><input type="text" id="movieTitle"></div>
    <div class="form-group"><label>IMDb ID (optional):</label><input type="text" id="movieImdbId"></div>
    <div class="form-group"><label>Image URL:</label><input type="text" id="movieImage" placeholder="https://i.imgur.com/abc123.jpg"></div>
    <div class="form-group"><label>Year:</label><input type="text" id="movieYear" placeholder="2025"></div>
    <div class="form-group"><label>Type:</label>
      <select id="contentType"><option value="movie">Movie</option><option value="tv_show">TV Show</option></select>
    </div>
    <div class="form-group"><label>Passwords (comma-separated):</label><input type="text" id="moviePassword"></div>
    <div class="form-group"><label>One-Time (optional):</label><input type="text" id="oneTimePassword"></div>
    <div class="form-group"><label><input type="checkbox" id="subtitlesEnabled"> Enable Subtitles</label></div>
    <button class="modal-btn" onclick="addMovie()">Add</button>
  </div>
</div>

<!-- Password Modal -->
<div id="passwordModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closePasswordModal()">x</button>
    <h2>Enter Password</h2>
    <p id="passwordMovieTitle" style="margin-bottom:1rem;color:#ccc"></p>
    <div class="form-group">
      <label for="moviePasswordInput">Password:</label>
      <input type="password" id="moviePasswordInput">
    </div>
    <button class="modal-btn" onclick="verifyMoviePassword()">Watch</button>
  </div>
</div>

<!-- Global Password Modal -->
<div id="globalPasswordModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeGlobalPasswordModal()">x</button>
    <h2>Add Global Password</h2>
    <div class="form-group"><label>Password:</label><input type="password" id="globalPassword"></div>
    <div class="form-group"><label><input type="checkbox" id="isOneTime"> One-Time</label></div>
    <button class="modal-btn" onclick="addGlobalPassword()">Add</button>
  </div>
</div>

<!-- Episode Modal -->
<div id="episodeModal" class="modal">
  <div class="modal-content">
    <button class="close-modal" onclick="closeEpisodeModal()">x</button>
    <h2>Select Episode</h2>
    <p id="episodeShowTitle" style="margin-bottom:1rem;color:#ccc"></p>
    <div class="form-group"><label>Season:</label><select id="seasonSelect" onchange="updateEpisodeSelect()"></select></div>
    <div class="form-group"><label>Episode:</label><select id="episodeSelect"></select></div>
    <button class="modal-btn" onclick="playSelectedEpisode()">Watch</button>
  </div>
</div>

<!-- Trailer Modal -->
<div id="trailerModal" class="modal">
  <div class="modal-content" style="width:90%;max-width:800px;height:80vh">
    <button class="close-modal" onclick="closeTrailer()">x</button>
    <iframe id="trailerIframe" style="width:100%;height:100%;border:none" allowfullscreen></iframe>
  </div>
</div>

<!-- Player -->
<div id="playerContainer" class="player-container">
  <button class="close-btn" onclick="closePlayer()">X</button>
  <div class="player-wrapper">
    <iframe id="playerIframe" allowfullscreen allow="autoplay; fullscreen" referrerpolicy="no-referrer"></iframe>
    <div class="iframe-overlay">ogmovie</div>
    <div class="bottom-left-overlay"></div>
  </div>
</div>

<script>
const API = window.location.origin + '/api';
const allGrid = document.getElementById('allGrid');
const movieGrid = document.getElementById('movieGrid');
const tvGrid = document.getElementById('tvGrid');
const favoritesGrid = document.getElementById('favoritesGrid');
const searchInput = document.getElementById('searchInput');
const filterTabs = document.querySelectorAll('.filter-tab');
const trailerModal = document.getElementById('trailerModal');
const trailerIframe = document.getElementById('trailerIframe');
const playerContainer = document.getElementById('playerContainer');
const playerIframe = document.getElementById('playerIframe');

let allMovies = [], movies = [], tvShows = [], favorites = [];
let currentFilter = 'all';
let clientId = localStorage.getItem('clientId') || crypto.randomUUID();
if (!localStorage.getItem('clientId')) localStorage.setItem('clientId', clientId);

let adminToken = null;
let selectedMovieId = null;
let selectedShow = null;
let authToken = null;
let episodeData = null;

// YOUR ORIGINAL IMAGE LOGIC â€” NO FALLBACK
function getMovieImage(movie) {
  return movie.image || 'https://via.placeholder.com/300x450/111/ccc?text=No+Image';
}

// Create Card
function createMovieCard(movie) {
  const card = document.createElement('div');
  card.className = 'movie-card';
  card.innerHTML = `
    <img src="${getMovieImage(movie)}" alt="${movie.title}" loading="lazy">
    <div class="info">
      <h3>${movie.title}</h3>
      <div class="year">${movie.year || 'N/A'}</div>
    </div>
    <div class="actions">
      <button class="trailer-btn" data-id="${movie.id}">Trailer</button>
      <button class="play-btn" data-id="${movie.id}">Play</button>
      <button class="fav-btn ${favorites.includes(movie.id) ? 'active' : ''}" data-id="${movie.id}">Heart</button>
    </div>
  `;

  const trailerBtn = card.querySelector('.trailer-btn');
  const playBtn = card.querySelector('.play-btn');
  const favBtn = card.querySelector('.fav-btn');

  trailerBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    playTrailer(movie.id);
  });

  playBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    requestMoviePassword(movie.id, movie.title, movie.type);
  });

  favBtn.addEventListener('click', (e) => {
    e.stopPropagation();
    toggleFavorite(movie.id, favBtn);
  });

  return card;
}

// Render
function renderSection(list, grid) {
  grid.innerHTML = '';
  if (list.length === 0) {
    grid.innerHTML = '<p style="grid-column:1/-1;text-align:center;color:#aaa">No content</p>';
    return;
  }
  list.forEach(m => grid.appendChild(createMovieCard(m)));
}

function renderCurrent() {
  const term = searchInput.value.toLowerCase();
  let filtered = [];

  if (currentFilter === 'all') filtered = allMovies;
  else if (currentFilter === 'movie') filtered = movies;
  else if (currentFilter === 'tv_show') filtered = tvShows;
  else filtered = favorites.map(id => allMovies.find(m => m.id === id) || {});

  filtered = filtered.filter(m => m.title?.toLowerCase().includes(term));
  const grid = currentFilter === 'all' ? allGrid :
               currentFilter === 'movie' ? movieGrid :
               currentFilter === 'tv_show' ? tvGrid : favoritesGrid;

  renderSection(filtered, grid);
}

// Filter
function switchFilter(filter) {
  currentFilter = filter;
  filterTabs.forEach(t => t.classList.remove('active'));
  document.querySelector(`[data-filter="${filter}"]`).classList.add('active');
  document.querySelectorAll('section').forEach(s => s.style.display = 'none');
  document.getElementById(
    filter === 'all' ? 'allSection' :
    filter === 'movie' ? 'movieSection' :
    filter === 'tv_show' ? 'tvSection' : 'favoritesSection'
  ).style.display = 'block';
  renderCurrent();
}

// Favorites
async function toggleFavorite(id, btn) {
  const isFav = favorites.includes(id);
  btn.classList.toggle('active', !isFav);

  if (isFav) {
    favorites = favorites.filter(f => f !== id);
    await fetch(API + '/favorites', { method: 'DELETE', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ movieId: id, clientId }) });
  } else {
    favorites.push(id);
    await fetch(API + '/favorites', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ movieId: id, clientId }) });
  }
  if (currentFilter === 'favorites') renderCurrent();
}

async function loadFavorites() {
  const res = await fetch(API + '/favorites/' + clientId);
  const data = await res.json();
  favorites = data.ok ? data.movies.map(m => m.id) : [];
}

// Trailer
async function playTrailer(movieId) {
  const res = await fetch(API + '/movies/' + movieId + '/trailer');
  const data = await res.json();
  if (data.ok) {
    trailerIframe.src = data.url;
    trailerModal.classList.add('active');
  } else {
    alert('Trailer not found');
  }
}

function closeTrailer() {
  trailerModal.classList.remove('active');
  trailerIframe.src = '';
}

// Load Movies
async function loadMovies() {
  try {
    const res = await fetch(API + '/movies');
    const data = await res.json();
    if (!data.ok) return;

    allMovies = data.movies;
    movies = allMovies.filter(m => m.type === 'movie');
    tvShows = allMovies.filter(m => m.type === 'tv_show');
    await loadFavorites();
    renderCurrent();
  } catch (err) {
    console.error(err);
  }
}

// Password & Player
function requestMoviePassword(id, title, type) {
  selectedMovieId = id;
  selectedShow = { id, title, type };
  document.getElementById('passwordMovieTitle').textContent = title;
  passwordModal.classList.add('active');
}

async function verifyMoviePassword() {
  const password = document.getElementById('moviePasswordInput').value;
  if (!password) return alert('Enter password');
  const res = await fetch(API + `/movies/${selectedMovieId}/authorize`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password })
  });
  const data = await res.json();
  if (!data.ok) return alert('Wrong password');
  authToken = data.token;

  if (selectedShow.type === 'movie') {
    const embedRes = await fetch(API + `/movies/${selectedMovieId}/embed`, {
      headers: { Authorization: `Bearer ${authToken}` }
    });
    const embedData = await embedRes.json();
    if (embedData.ok) showPlayer(embedData.url);
  } else {
    await loadEpisodes();
  }
}

async function loadEpisodes() {
  const res = await fetch(API + `/movies/${selectedMovieId}/episodes`);
  const data = await res.json();
  if (!data.ok) return alert('Failed to load episodes');
  episodeData = data.seasons;
  const sel = document.getElementById('seasonSelect');
  sel.innerHTML = '';
  Object.keys(episodeData).forEach(s => {
    const opt = document.createElement('option');
    opt.value = s; opt.textContent = `Season ${s}`;
    sel.appendChild(opt);
  });
  updateEpisodeSelect();
  episodeModal.classList.add('active');
}

function updateEpisodeSelect() {
  const s = document.getElementById('seasonSelect').value;
  const e = document.getElementById('episodeSelect');
  e.innerHTML = '';
  (episodeData[s] || []).forEach(ep => {
    const opt = document.createElement('option');
    opt.value = ep.episode;
    opt.textContent = `${ep.name} (E${ep.episode})`;
    e.appendChild(opt);
  });
}

async function playSelectedEpisode() {
  const s = document.getElementById('seasonSelect').value;
  const e = document.getElementById('episodeSelect').value;
  const res = await fetch(API + `/movies/${selectedMovieId}/embed`, {
    headers: { Authorization: `Bearer ${authToken}` }
  });
  const data = await res.json();
  if (data.ok) {
    showPlayer(`${data.url}/${s}/${e}`);
    episodeModal.classList.remove('active');
  }
}

function showPlayer(url) {
  playerIframe.src = url;
  playerContainer.classList.add('active');
  passwordModal.classList.remove('active');
  document.getElementById('moviePasswordInput').value = '';
}

function closePlayer() {
  playerContainer.classList.remove('active');
  playerIframe.src = '';
  authToken = null;
}

// Admin
function openAdminPanel() { loginModal.classList.add('active'); }
function closeLoginModal() { loginModal.classList.remove('active'); }
function closeAddMovieModal() { addMovieModal.classList.remove('active'); }
function closePasswordModal() { passwordModal.classList.remove('active'); }
function closeGlobalPasswordModal() { globalPasswordModal.classList.remove('active'); }
function closeEpisodeModal() { episodeModal.classList.remove('active'); }

async function adminLogin() {
  const pw = document.getElementById('adminPassword').value;
  const res = await fetch(API + '/admin/login', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ password: pw })
  });
  const data = await res.json();
  if (data.ok) {
    adminToken = data.token;
    closeLoginModal();
    document.getElementById('adminPanel').classList.add('active');
    loadAdminMovies();
    loadGlobalPasswords();
  } else alert('Wrong password');
}

function openAddMovieModal() { addMovieModal.classList.add('active'); }
function openGlobalPasswordModal() { globalPasswordModal.classList.add('active'); }

async function addMovie() {
  const title = document.getElementById('movieTitle').value;
  const imdbId = document.getElementById('movieImdbId').value;
  const image = document.getElementById('movieImage').value;
  const year = document.getElementById('movieYear').value;
  const type = document.getElementById('contentType').value;
  const pw = document.getElementById('moviePassword').value.split(',').map(p=>p.trim()).filter(p=>p);
  const otp = document.getElementById('oneTimePassword').value.split(',').map(p=>p.trim()).filter(p=>p);
  const sub = document.getElementById('subtitlesEnabled').checked;

  const res = await fetch(API + '/movies', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${adminToken}` },
    body: JSON.stringify({ name: title, imdbId, image, year, contentPasswords: pw, oneTimePasswords: otp, type, subtitlesEnabled: sub })
  });
  const data = await res.json();
  if (data.ok) {
    closeAddMovieModal();
    loadAdminMovies();
    loadMovies();
  } else alert('Failed: ' + data.error);
}

async function loadAdminMovies() {
  const list = document.getElementById('movieListAdmin');
  list.innerHTML = '';
  const res = await fetch(API + '/movies');
  const data = await res.json();
  if (data.ok) {
    data.movies.forEach(m => {
      const item = document.createElement('div');
      item.className = 'movie-item-admin';
      item.innerHTML = `
        <div>${m.title} (${m.type}) - Subs: ${m.subtitles_enabled ? 'On' : 'Off'}</div>
        <div>
          <button onclick="toggleSubtitles(${m.id}, ${!m.subtitles_enabled})">${m.subtitles_enabled ? 'Disable' : 'Enable'} Subs</button>
          <button onclick="deleteMovie(${m.id})">Delete</button>
        </div>
      `;
      list.appendChild(item);
    });
  }
}

async function toggleSubtitles(id, enable) {
  const res = await fetch(API + '/movies/' + id + '/subtitles', {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${adminToken}` },
    body: JSON.stringify({ subtitlesEnabled: enable })
  });
  const data = await res.json();
  if (data.ok) {
    loadAdminMovies();
    loadMovies();
  }
}

async function deleteMovie(id) {
  if (!confirm('Delete this content?')) return;
  const res = await fetch(API + '/movies/' + id, { method: 'DELETE', headers: { Authorization: `Bearer ${adminToken}` } });
  const data = await res.json();
  if (data.ok) {
    loadAdminMovies();
    loadMovies();
  }
}

async function loadGlobalPasswords() {
  const list = document.getElementById('globalPasswordList');
  list.innerHTML = '';
  const res = await fetch(API + '/admin/global-passwords', { headers: { Authorization: `Bearer ${adminToken}` } });
  const data = await res.json();
  if (data.ok && data.passwords.length) {
    data.passwords.forEach(p => {
      const item = document.createElement('div');
      item.className = 'movie-item-admin';
      item.innerHTML = `<div>${p.is_one_time ? 'One-Time' : 'Regular'} Password</div><button onclick="deleteGlobalPassword(${p.id})">Delete</button>`;
      list.appendChild(item);
    });
  } else {
    list.innerHTML = '<p>No global passwords</p>';
  }
}

async function deleteGlobalPassword(id) {
  if (!confirm('Delete global password?')) return;
  const res = await fetch(API + '/admin/global-passwords/' + id, { method: 'DELETE', headers: { Authorization: `Bearer ${adminToken}` } });
  const data = await res.json();
  if (data.ok) loadGlobalPasswords();
}

async function addGlobalPassword() {
  const pw = document.getElementById('globalPassword').value;
  const one = document.getElementById('isOneTime').checked;
  const res = await fetch(API + '/admin/global-passwords', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', Authorization: `Bearer ${adminToken}` },
    body: JSON.stringify({ password: pw, isOneTime: one })
  });
  const data = await res.json();
  if (data.ok) {
    closeGlobalPasswordModal();
    loadGlobalPasswords();
  }
}

// Events
document.getElementById('adminBtn').addEventListener('click', openAdminPanel);
searchInput.addEventListener('input', renderCurrent);
filterTabs.forEach(tab => tab.addEventListener('click', () => switchFilter(tab.dataset.filter)));
document.addEventListener('keydown', e => {
  if (e.key === 'Escape') {
    closePlayer(); closeTrailer(); closeLoginModal(); closeAddMovieModal();
    closePasswordModal(); closeGlobalPasswordModal(); closeEpisodeModal();
  }
});

// Init
loadMovies();
</script>
</body>
</html>
